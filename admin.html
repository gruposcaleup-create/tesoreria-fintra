<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JULG Panel Administrador</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(214.3 31.8% 91.4%)", input: "hsl(214.3 31.8% 91.4%)", ring: "hsl(215 20.2% 65.1%)", background: "hsl(0 0% 100%)", foreground: "hsl(222.2 47.4% 11.2%)", primary: { DEFAULT: "hsl(222.2 47.4% 11.2%)", foreground: "hsl(210 40% 98%)" }, destructive: { DEFAULT: "hsl(0 100% 50%)", foreground: "hsl(210 40% 98%)" }, muted: { DEFAULT: "hsl(210 40% 96.1%)", foreground: "hsl(215.4 16.3% 46.9%)" }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .hide {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .video-thumbnail {
            aspect-ratio: 16/9;
            background-color: #f1f5f9;
            position: relative;
            overflow: hidden;
            border-radius: 0.375rem;
        }

        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .play-icon-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            padding: 0.5rem;
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-900 min-h-screen overflow-hidden md:overflow-auto">

    <script src="./api.js"></script>
    <script>
        // Simple initialization check with session isolation
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.API) {
                console.log('✅ API loaded');

                // Check if logged in using admin context
                if (window.API.isLoggedIn()) {
                    try {
                        const profile = await window.API.apiGetProfile();
                        console.log('Profile loaded:', profile);

                        // CRITICAL: Block non-admin users from accessing admin panel
                        if (!profile || (profile.role !== 'admin' && profile.role !== 'editor')) {
                            console.warn('⛔ Access denied: User role is not admin/editor');
                            alert('No tienes permisos para acceder al panel administrativo.');
                            window.location.href = 'panel.html';
                            return;
                        }

                        // Show App, Hide Login (Persistence Fix)
                        document.getElementById('login-view').classList.add('hide');
                        document.getElementById('app-layout').classList.remove('hide');
                        if (window.loadAdminData) window.loadAdminData();

                    } catch (e) {
                        console.error("Auth check failed", e);
                        // If auth check fails, redirect to login
                        window.location.href = 'admin.html';  // Will show login screen
                    }
                }
                window.dispatchEvent(new CustomEvent('api-ready'));
            } else {
                console.error('❌ API failed to load');
            }
        });
    </script>

    <div id="login-view"
        class="flex h-screen w-full items-center justify-center bg-gray-100 z-50 absolute top-0 left-0 px-4">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-lg w-full max-w-sm border border-gray-200">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center p-3 bg-slate-900 rounded-full mb-4">
                    <i data-lucide="lock" class="text-white h-6 w-6"></i>
                </div>
                <h1 class="text-xl sm:text-2xl font-bold">JULG Admin</h1>
                <p class="text-xs sm:text-sm text-gray-500">Ingresa para administrar la tienda</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium mb-1">Email</label>
                    <input type="email" id="email"
                        class="w-full p-2 border rounded-md focus:ring-2 focus:ring-slate-400 outline-none text-sm">
                </div>
                <div class="relative">
                    <label class="block text-xs sm:text-sm font-medium mb-1">Contraseña</label>
                    <input type="password" id="password"
                        class="w-full p-2 border rounded-md focus:ring-2 focus:ring-slate-400 outline-none pr-10 text-sm">
                    <button type="button" onclick="togglePassword()" class="absolute right-3 top-8 text-gray-400"><i
                            data-lucide="eye" class="h-4 w-4"></i></button>
                </div>
                <button type="submit"
                    class="w-full bg-slate-900 text-white py-2 rounded-md hover:bg-slate-800 transition text-sm font-medium">Iniciar
                    Sesión</button>
                <p class="text-[10px] sm:text-xs text-center text-gray-400 mt-2">
                    Ingresa tus credenciales asignadas.
                </p>
            </form>
        </div>
    </div>

    <div id="app-layout" class="flex h-screen hide flex-col md:flex-row">
        <aside class="w-full md:w-64 bg-white border-r border-gray-200 flex flex-col hidden md:flex h-auto md:h-screen">
            <div class="p-4 sm:p-6 border-b border-gray-100">
                <h2 class="font-bold text-lg sm:text-xl text-slate-800">JULG Panel</h2>
                <span class="text-[10px] sm:text-xs text-gray-400">Administrador v1.0</span>
            </div>
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="router('dashboard')"
                    class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100 transition text-sm"
                    data-target="dashboard"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> <span
                        class="hidden sm:inline">Dashboard</span></button>
                <button onclick="router('courses')"
                    class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100 transition text-sm"
                    data-target="courses"><i data-lucide="shopping-bag" class="w-5 h-5"></i> <span
                        class="hidden sm:inline">Cursos</span></button>
                <button onclick="router('coupons')"
                    class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100 transition text-sm"
                    data-target="coupons"><i data-lucide="ticket" class="w-5 h-5"></i> <span
                        class="hidden sm:inline">Cupones</span></button>
                <button onclick="router('resources')"
                    class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100 transition text-sm"
                    data-target="resources"><i data-lucide="file-box" class="w-5 h-5"></i> <span
                        class="hidden sm:inline">Recursos</span></button>
                <button onclick="router('members')"
                    class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100 transition text-sm"
                    data-target="members"><i data-lucide="users" class="w-5 h-5"></i> <span
                        class="hidden sm:inline">Miembros</span></button>
                <button onclick="router('comments')"
                    class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100 transition text-sm"
                    data-target="comments"><i data-lucide="message-square" class="w-5 h-5"></i> <span
                        class="hidden sm:inline">Comentarios</span></button>

                <button onclick="router('settings')"
                    class="nav-btn w-full flex items-center gap-3 px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100 transition text-sm"
                    data-target="settings"><i data-lucide="settings" class="w-5 h-5"></i> <span
                        class="hidden sm:inline">Configuración</span></button>
            </nav>
            <div class="p-4 border-t border-gray-100">
                <button onclick="logout()"
                    class="w-full flex items-center gap-2 text-red-600 hover:bg-red-50 p-2 rounded-md transition text-sm"><i
                        data-lucide="log-out" class="w-4 h-4"></i> <span class="hidden sm:inline">Cerrar
                        Sesión</span></button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-gray-50 p-4 sm:p-8 w-full" id="main-content">
            <div id="view-dashboard" class="view-section fade-in">
                <h1 class="text-3xl font-bold text-slate-800">Dashboard</h1>
                <h1 class="text-3xl font-bold text-slate-800">Dashboard</h1>
                <div class="text-sm font-medium text-slate-500 bg-white px-4 py-2 rounded shadow-sm">
                    <span id="current-date"></span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-6 rounded-xl border shadow-sm">
                        <div class="flex justify-between items-center mb-2"><span
                                class="text-sm font-medium text-gray-500">Ingresos Totales</span><i
                                data-lucide="dollar-sign" class="w-4 h-4 text-gray-400"></i></div>
                        <div id="kpi-revenue" class="text-2xl font-bold">$0.00</div>
                        <p class="text-xs text-green-600 mt-1 flex items-center"><i data-lucide="arrow-up-right"
                                class="w-3 h-3 mr-1"></i> Calculado de Miembros</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border shadow-sm">
                        <div class="flex justify-between items-center mb-2"><span
                                class="text-sm font-medium text-gray-500">Estudiantes</span><i data-lucide="users"
                                class="w-4 h-4 text-gray-400"></i></div>
                        <div id="kpi-students" class="text-2xl font-bold">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border shadow-sm">
                        <div class="flex justify-between items-center mb-2"><span
                                class="text-sm font-medium text-gray-500">Ventas Mes</span><i data-lucide="credit-card"
                                class="w-4 h-4 text-gray-400"></i></div>
                        <div id="month-sales" class="text-2xl font-bold">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border shadow-sm">
                        <div class="flex justify-between items-center mb-2"><span
                                class="text-sm font-medium text-gray-500">Cursos Activos</span><i data-lucide="activity"
                                class="w-4 h-4 text-gray-400"></i></div>
                        <div id="kpi-active-courses" class="text-2xl font-bold">0</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl border shadow-sm">
                        <h3 class="font-semibold mb-4">Ingresos Mensuales</h3><canvas id="revenueChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl border shadow-sm">
                        <h3 class="font-semibold mb-4">Ventas Recientes</h3>
                        <div id="recent-sales-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <div id="view-courses" class="view-section hide fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-bold">Mis Cursos</h1>
                        <p class="text-gray-500">Gestiona tu catálogo educativo.</p>
                    </div>
                    <button onclick="resetAndCreateCourse()"
                        class="bg-slate-900 text-white px-4 py-2 rounded-md flex items-center hover:bg-slate-800"><i
                            data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> Crear Curso</button>
                </div>
                <div id="courses-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="view-create-course" class="view-section hide fade-in pb-20">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-4">
                        <button onclick="router('courses')" class="p-2 border rounded-md hover:bg-gray-100"><i
                                data-lucide="arrow-left" class="w-4 h-4"></i></button>
                        <div>
                            <h1 class="text-3xl font-bold" id="form-page-title">Crear Nuevo Curso</h1>
                            <p class="text-gray-500">Configura módulos, precios y categorías.</p>
                        </div>
                    </div>
                    <button onclick="saveCourse()"
                        class="bg-slate-900 text-white px-4 py-2 rounded-md flex items-center hover:bg-slate-800">
                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                        <span id="form-save-btn-text">Guardar Curso</span>
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <h3 class="font-semibold mb-4">Información General</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Título del Curso</label>
                                    <input type="text" id="course-title" class="w-full p-2 border rounded-lg"
                                        placeholder="Ej: Master en React">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Descripción</label>
                                    <textarea id="course-desc" class="w-full p-2 border rounded-lg h-24"
                                        placeholder="¿De qué trata?"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Duración (texto libre)</label>
                                    <input type="text" id="course-duration" placeholder="Ej. 12 Horas, 3 Semanas"
                                        class="w-full p-2 border rounded-lg">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Precio Real ($)</label>
                                        <input type="number" id="price-real" class="w-full p-2 border rounded-md">
                                    </div>
                                    <div class="bg-green-50 p-3 rounded border border-green-100">
                                        <div class="flex justify-between mb-1"><label
                                                class="block text-sm font-bold text-green-700">Precio Oferta
                                                ($)</label><span
                                                class="text-[10px] bg-green-200 text-green-800 px-2 rounded-full font-bold">OFERTA</span>
                                        </div>
                                        <input type="number" id="price-offer"
                                            class="w-full p-2 border border-green-200 rounded-md bg-white">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-semibold">Plan de Estudios</h3><button onclick="addModule()"
                                    class="text-sm bg-gray-100 px-3 py-1 rounded hover:bg-gray-200 border flex items-center"><i
                                        data-lucide="plus" class="w-3 h-3 mr-1"></i> Módulo</button>
                            </div>
                            <div id="modules-container" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-semibold flex items-center"><i data-lucide="tag"
                                        class="w-4 h-4 mr-2"></i> Clasificación</h3><button
                                    onclick="toggleCategoryModal()"
                                    class="text-xs text-blue-600 flex items-center hover:underline"><i
                                        data-lucide="settings" class="w-3 h-3 mr-1"></i> Gestionar</button>
                            </div>
                            <select id="course-category" class="w-full p-2 border rounded-md bg-white"></select>
                            <div id="category-manager" class="hidden mt-4 p-3 bg-gray-50 border rounded-md">
                                <div class="flex gap-2 mb-2"><input type="text" id="new-cat-input"
                                        placeholder="Nueva..." class="flex-1 p-1 text-sm border rounded"><button
                                        onclick="addCategory()" class="bg-blue-600 text-white p-1 rounded"><i
                                            data-lucide="plus" class="w-4 h-4"></i></button></div>
                                <ul id="category-list-ui" class="space-y-1 text-sm max-h-32 overflow-y-auto"></ul>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <h3 class="font-semibold mb-4">Multimedia</h3>
                            <div onclick="document.getElementById('course-cover-input').click()"
                                class="relative border-2 border-dashed rounded-lg p-0 text-center cursor-pointer hover:bg-gray-50 transition overflow-hidden h-40 flex items-center justify-center group">
                                <input type="file" id="course-cover-input" class="hidden" accept="image/*"
                                    onchange="handleCourseCoverUpload(this)">

                                <div id="cover-placeholder" class="p-6">
                                    <i data-lucide="image" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                    <span class="text-sm text-gray-500">Subir Portada</span>
                                </div>

                                <img id="cover-preview" src=""
                                    class="absolute inset-0 w-full h-full object-cover hidden">

                                <div id="cover-overlay"
                                    class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition hidden">
                                    <span class="text-white text-xs font-medium"><i data-lucide="upload"
                                            class="w-4 h-4 inline mr-1"></i> Cambiar</span>
                                </div>
                            </div>
                            <div class="mt-4"><label class="block text-sm font-medium mb-1">Video Promo
                                    (URL)</label><input type="text" id="course-video-promo"
                                    class="w-full p-2 border rounded-md text-sm" placeholder="https://youtube.com/...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-coupons" class="view-section hide fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Cupones</h1><button onclick="openCouponModal()"
                        class="bg-slate-900 text-white px-4 py-2 rounded-md flex items-center hover:bg-slate-800"><i
                            data-lucide="plus" class="w-4 h-4 mr-2"></i> Crear Cupón</button>
                </div>
                <dialog id="coupon-modal" class="p-0 rounded-lg shadow-xl border w-full max-w-md backdrop:bg-black/50">
                    <div class="p-6">
                        <h3 class="text-lg font-bold mb-4">Nuevo Cupón</h3>
                        <div class="space-y-4">
                            <div><label class="block text-sm mb-1">Código</label>
                                <div class="flex gap-2"><input type="text" id="coupon-code"
                                        class="w-full border p-2 rounded uppercase font-mono"><button
                                        onclick="generateCode()" class="border p-2 rounded hover:bg-gray-50"><i
                                            data-lucide="wand-2" class="w-4 h-4 text-purple-600"></i></button></div>
                            </div>
                            <div><label class="block text-sm mb-1">Descuento (%)</label><input type="number"
                                    id="coupon-discount" class="w-full border p-2 rounded"></div>
                            <div class="flex justify-end gap-2 mt-6"><button
                                    onclick="document.getElementById('coupon-modal').close()"
                                    class="px-4 py-2 border rounded">Cancelar</button><button onclick="saveCoupon()"
                                    class="px-4 py-2 bg-slate-900 text-white rounded">Guardar</button></div>
                        </div>
                    </div>
                </dialog>
                <div class="bg-white rounded-lg border shadow-sm overflow-hidden overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4">Código</th>
                                <th class="p-4">Descuento</th>
                                <th class="p-4">Estado</th>
                                <th class="p-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="coupons-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-resources" class="view-section hide fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Recursos Gratuitos</h1><button onclick="openResourceModal()"
                        class="bg-slate-900 text-white px-4 py-2 rounded-md flex items-center hover:bg-slate-800"><i
                            data-lucide="upload-cloud" class="w-4 h-4 mr-2"></i> Subir Recurso</button>
                </div>
                <div class="bg-white rounded-lg border shadow-sm overflow-hidden overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 w-16">Tipo</th>
                                <th class="p-4">Nombre</th>
                                <th class="p-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="resources-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-members" class="view-section hide fade-in">
                <!-- ... Content of members ... -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-bold">Miembros</h1>
                        <p class="text-gray-500 text-sm">Gestiona usuarios y administradores.</p>
                    </div>
                    <div class="flex gap-2">
                        <div class="relative"><i data-lucide="search"
                                class="absolute left-3 top-2.5 h-4 w-4 text-gray-400"></i><input type="text"
                                placeholder="Buscar..." class="pl-9 p-2 border rounded-md w-64 text-sm"
                                onkeyup="filterMembers(this.value)">
                        </div>
                        <button onclick="openCreateUserModal()"
                            class="bg-slate-900 text-white px-4 py-2 rounded-md flex items-center hover:bg-slate-800">
                            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i> Nuevo Usuario
                        </button>
                    </div>
                </div>

                <!-- Enrollments Modal -->
                <dialog id="enrollments-modal"
                    class="p-0 rounded-lg shadow-xl border w-full max-w-lg backdrop:bg-black/50">
                    <div class="p-6">
                        <h3 class="text-lg font-bold mb-4">Cursos del Usuario</h3>
                        <div id="enrollments-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
                        <div class="flex justify-end">
                            <button onclick="document.getElementById('enrollments-modal').close()"
                                class="px-4 py-2 border rounded">Cerrar</button>
                        </div>
                    </div>
                </dialog>

                <div class="bg-white rounded-lg border shadow-sm overflow-hidden overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4">Usuario</th>
                                <th class="p-4">Rol</th>
                                <th class="p-4">Estado</th>
                                <th class="p-4">Cursos</th>
                                <th class="p-4">Gastado</th>
                                <th class="p-4 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="members-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-comments" class="view-section hide fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Comentarios</h1>
                    <p class="text-gray-500">Moderación de comentarios.</p>
                </div>

                <!-- Reply Modal -->
                <dialog id="reply-modal" class="p-0 rounded-lg shadow-xl border w-full max-w-md backdrop:bg-black/50">
                    <div class="p-6">
                        <h3 class="text-lg font-bold mb-4">Responder Comentario</h3>
                        <input type="hidden" id="reply-parent-id">
                        <input type="hidden" id="reply-course-id">
                        <input type="hidden" id="reply-lesson-id">
                        <div class="space-y-4">
                            <textarea id="reply-content" class="w-full border p-2 rounded h-32"
                                placeholder="Escribe tu respuesta..."></textarea>
                            <div class="flex justify-end gap-2">
                                <button onclick="document.getElementById('reply-modal').close()"
                                    class="px-4 py-2 border rounded">Cancelar</button>
                                <button onclick="sendReply()" class="px-4 py-2 bg-slate-900 text-white rounded">Enviar
                                    Respuesta</button>
                            </div>
                        </div>
                    </div>
                </dialog>

                <div class="bg-white rounded-lg border shadow-sm overflow-hidden overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 w-32">Usuario</th>
                                <th class="p-4">Comentario</th>
                                <th class="p-4 w-40">Curso</th>
                                <th class="p-4 w-32">Fecha</th>
                                <th class="p-4 text-right w-24">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="comments-table-body"></tbody>
                    </table>
                </div>
            </div>


            <div id="view-settings" class="view-section hide fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Configuración</h1>
                    <button onclick="saveSettings()"
                        class="bg-slate-900 text-white px-4 py-2 rounded-md flex items-center hover:bg-slate-800"><i
                            data-lucide="save" class="w-4 h-4 mr-2"></i> Guardar Cambios</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl border shadow-sm">
                        <h3 class="font-bold text-lg mb-4 flex items-center"><i data-lucide="crown"
                                class="w-5 h-5 mr-2 text-yellow-500"></i> Membresía Anual</h3>
                        <p class="text-sm text-gray-500 mb-4">Define el precio de la membresía "Todo Incluido" que da
                            acceso a toda la tienda por 1 año.</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Precio Real ($)</label>
                                <input type="number" id="setting-membership-price" class="w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Precio Oferta ($)</label>
                                <input type="number" id="setting-membership-price-offer"
                                    class="w-full p-2 border rounded-md" placeholder="Opcional">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Recursos -->
            <dialog id="resource-modal" class="p-0 rounded-lg shadow-xl border w-full max-w-md backdrop:bg-black/50">
                <div class="p-6">
                    <h3 class="text-lg font-bold mb-4">Subir Nuevo Recurso</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1">Nombre del Archivo</label>
                            <input type="text" id="resource-name" class="w-full border p-2 rounded"
                                placeholder="Ej: Guía Fiscal 2024.pdf">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Descripción</label>
                            <textarea id="resource-desc" class="w-full border p-2 rounded h-24"
                                placeholder="Describe el contenido..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Archivo</label>
                            <input type="file" id="resource-file-input"
                                class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-slate-50 file:text-slate-700 hover:file:bg-slate-100">
                        </div>
                        <div class="flex justify-end gap-2 mt-6">
                            <button onclick="document.getElementById('resource-modal').close()"
                                class="px-4 py-2 border rounded">Cancelar</button>
                            <button onclick="uploadResource()"
                                class="px-4 py-2 bg-slate-900 text-white rounded flex items-center gap-2"> <i
                                    data-lucide="upload" class="w-4 h-4"></i> Subir</button>
                        </div>
                    </div>
                </div>
            </dialog>

            <!-- Modal Crear Usuario -->
            <dialog id="create-user-modal" class="p-0 rounded-lg shadow-xl border w-full max-w-md backdrop:bg-black/50">
                <div class="p-6">
                    <h3 class="text-lg font-bold mb-4">Crear Nuevo Usuario</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm mb-1">Nombre</label>
                                <input type="text" id="new-user-firstname" class="w-full border p-2 rounded">
                            </div>
                            <div>
                                <label class="block text-sm mb-1">Apellido</label>
                                <input type="text" id="new-user-lastname" class="w-full border p-2 rounded">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Email</label>
                            <input type="email" id="new-user-email" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Contraseña</label>
                            <input type="password" id="new-user-password" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm mb-1">Rol</label>
                            <select id="new-user-role" class="w-full border p-2 rounded bg-white">
                                <option value="user">Usuario</option>
                                <option value="admin">Administrador</option>
                                <option value="editor">Editor</option>
                            </select>
                        </div>
                        <div class="flex justify-end gap-2 mt-6">
                            <button onclick="document.getElementById('create-user-modal').close()"
                                class="px-4 py-2 border rounded">Cancelar</button>
                            <button onclick="createNewUser()"
                                class="px-4 py-2 bg-slate-900 text-white rounded flex items-center gap-2">Crear</button>
                        </div>
                    </div>
                </div>
            </dialog>

            <!-- Modal Ban Duration -->
            <dialog id="ban-modal" class="p-0 rounded-lg shadow-xl border w-full max-w-sm backdrop:bg-black/50">
                <div class="p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center text-orange-600"><i data-lucide="clock"
                            class="w-5 h-5 mr-2"></i> Banear Temporalmente</h3>
                    <input type="hidden" id="ban-user-id">
                    <p class="text-sm text-gray-500 mb-4">El usuario no podrá acceder a la plataforma durante este
                        tiempo.</p>

                    <label class="block text-sm font-medium mb-2">Duración de la suspensión</label>
                    <select id="ban-duration" class="w-full border p-2 rounded bg-white mb-6">
                        <option value="1">1 Minuto (Prueba)</option>
                        <option value="60">1 Hora</option>
                        <option value="1440" selected>24 Horas</option>
                        <option value="4320">3 Días</option>
                        <option value="10080">1 Semana</option>
                        <option value="43200">1 Mes</option>
                    </select>

                    <div class="flex justify-end gap-2">
                        <button onclick="document.getElementById('ban-modal').close()"
                            class="px-4 py-2 border rounded hover:bg-gray-50">Cancelar</button>
                        <button onclick="confirmBan()"
                            class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">Confirmar
                            Ban</button>
                    </div>
                </div>
            </dialog>

            <!-- Modal Cambio de Rol (Opcional, se puede hacer inline) -->
            <dialog id="role-modal" class="p-0 rounded-lg shadow-xl border w-full max-w-sm backdrop:bg-black/50">
                <div class="p-6">
                    <h3 class="text-lg font-bold mb-4">Cambiar Rol</h3>
                    <input type="hidden" id="edit-role-userid">
                    <select id="edit-role-select" class="w-full border p-2 rounded bg-white mb-4">
                        <option value="user">Usuario</option>
                        <option value="admin">Administrador</option>
                        <option value="editor">Editor</option>
                    </select>
                    <div class="flex justify-end gap-2">
                        <button onclick="document.getElementById('role-modal').close()"
                            class="px-4 py-2 border rounded">Cancelar</button>
                        <button onclick="confirmRoleChange()"
                            class="px-4 py-2 bg-slate-900 text-white rounded">Guardar</button>
                    </div>
                </div>
            </dialog>

        </main>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

    <script>
        // ESTADO
        const state = {
            currentUser: null,
            editingCourseId: null, // NUEVO: Para saber si estamos editando
            metrics: null, // Store dashboard metrics
            currentCourseImage: null,
            categories: [],
            courses: [],
            coupons: [],
            resources: [],
            members: [],
            expandedUserId: null, // Track expanded user row
            tempModules: []
        };

        // ROUTER
        function router(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hide'));
            const target = document.getElementById(`view-${viewName}`);
            if (target) target.classList.remove('hide');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.target === viewName) {
                    btn.classList.add('bg-slate-900', 'text-white'); btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                } else {
                    btn.classList.remove('bg-slate-900', 'text-white'); btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                }
            });

            if (viewName === 'members') renderMembers();
            if (viewName === 'settings') renderSettings();
            if (viewName === 'coupons') renderCoupons();
            if (viewName === 'resources') renderResources();
            if (viewName === 'courses') renderCoursesList();
            if (viewName === 'comments') renderComments();  // Add this line
            if (viewName === 'dashboard') {
                if (state.metrics) {
                    updateDashboard(state.metrics);
                    initChart(state.metrics);
                }
            }

            // Si vamos a crear curso y NO estamos editando, limpiar
            if (viewName === 'create-course' && !state.editingCourseId) {
                resetForm();
            }
            lucide.createIcons();
        }

        // --- CONFIGURACIÓN ---
        async function renderSettings() {
            try {
                // Ensure API is ready before calling
                if (!window.API || !window.API.apiGetSettings) {
                    console.warn('API not ready, retrying renderSettings in 500ms');
                    setTimeout(renderSettings, 500);
                    return;
                }
                const settings = await window.API.apiGetSettings();
                if (settings) {
                    document.getElementById('setting-membership-price').value = settings.membership_price || 999;
                    document.getElementById('setting-membership-price-offer').value = settings.membership_price_offer || '';
                }
            } catch (err) { console.error('Error fetching settings:', err); }
        }

        async function saveSettings() {
            const price = document.getElementById('setting-membership-price').value;
            const offer = document.getElementById('setting-membership-price-offer').value;

            if (!window.API || !window.API.apiSaveSettings) {
                showToast('Error: API no cargada', 'error');
                return;
            }

            try {
                const result = await window.API.apiSaveSettings({ membership_price: price, membership_price_offer: offer });
                console.log('Settings saved result:', result);
                showToast('Configuración guardada correctamente', 'success');
            } catch (e) {
                console.error('Save settings error:', e);
                showToast('Error guardando configuración: ' + e.message, 'error');
            }
        }


        // --- RECURSOS ---
        function renderResources() {
            const tbody = document.getElementById('resources-table-body');
            tbody.innerHTML = state.resources.map(r => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4"><i data-lucide="${r.type.includes('pdf') ? 'file-text' : 'file'}" class="w-5 h-5 text-gray-400"></i></td>
                    <td class="p-4">
                        <div class="font-medium">${r.name}</div>
                        <div class="text-xs text-gray-500">${r.description || ''}</div>
                    </td>
                    <td class="p-4 text-right">
                        <a href="/api/resources/${r.id}/download" download="${r.name}" class="text-blue-600 hover:text-blue-800 mr-3 px-2 py-1 rounded hover:bg-blue-50">
                            <i data-lucide="download" class="w-4 h-4 inline"></i>
                        </a>
                        <button onclick="deleteResource(${r.id})" class="text-red-600 hover:text-red-800 p-1 rounded hover:bg-red-50">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function openResourceModal() {
            document.getElementById('resource-name').value = '';
            document.getElementById('resource-desc').value = '';
            document.getElementById('resource-file-input').value = '';
            document.getElementById('resource-modal').showModal();
        }

        async function uploadResource() {
            const fileInput = document.getElementById('resource-file-input');
            const file = fileInput.files[0];
            const desc = document.getElementById('resource-desc').value;
            const name = document.getElementById('resource-name').value || (file ? file.name : 'Recurso');

            if (!file) return showToast('Selecciona un archivo', 'error');

            const reader = new FileReader();
            reader.onload = async (e) => {
                const dataUrl = e.target.result;
                try {
                    await window.API.apiCreateResource({
                        name: name,
                        description: desc,
                        type: file.type,
                        dataUrl: dataUrl
                    });
                    showToast('Recurso subido correctamente', 'success');
                    document.getElementById('resource-modal').close();
                    state.resources = await window.API.apiGetResources();
                    renderResources();
                } catch (err) {
                    showToast('Error al subir recurso', 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        async function deleteResource(id) {
            if (!confirm("¿Seguro que deseas eliminar este recurso?")) return;
            try {
                await window.API.apiDeleteResource(id);
                showToast("Recurso eliminado", "success");
                state.resources = await window.API.apiGetResources();
                renderResources();
            } catch (e) { showToast("Error al eliminar", "error"); }
        }

        // --- MIEMBROS ---
        function renderMembers(filtered = null) {
            const list = filtered || state.members;

            // DEDUPLICATION: Use Map by Email to ensure uniqueness
            const uniqueMap = new Map();
            list.forEach(m => uniqueMap.set(m.email, m));
            const uniqueList = Array.from(uniqueMap.values());

            const staff = uniqueList.filter(m => m.role === 'admin' || m.role === 'editor');
            const customers = uniqueList.filter(m => m.role !== 'admin' && m.role !== 'editor');

            const tbody = document.getElementById('members-table-body');
            tbody.innerHTML = '';

            // 1. Staff Section
            if (staff.length > 0) {
                tbody.innerHTML += `
                    <tr><td colspan="6" class="p-4 bg-slate-100 font-bold text-slate-700 text-sm uppercase tracking-wider border-y">Equipo Administrativo (${staff.length})</td></tr>
                `;
                tbody.innerHTML += staff.map(m => `
                    <tr class="border-b hover:bg-gray-50 bg-white">
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center font-bold text-purple-700 text-xs shadow-sm">
                                    ${(m.firstName || 'A').substring(0, 1).toUpperCase()}
                                </div>
                                <div class="flex flex-col">
                                    <span class="font-medium text-slate-900">${m.firstName || 'Admin'} ${m.lastName || ''}</span>
                                    <span class="text-xs text-gray-400 font-mono">${m.email}</span>
                                </div>
                            </div>
                        </td>
                        <td class="p-4"><span class="px-2 py-0.5 rounded text-xs font-bold uppercase ${m.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">${m.role}</span></td>
                        <td class="p-4">
                            ${m.status === 'blocked'
                        ? '<span class="text-red-600 text-xs font-bold bg-red-100 px-2 py-0.5 rounded">Bloqueado</span>'
                        : '<span class="text-green-600 text-xs font-bold">Activo</span>'}
                        </td>
                        <td class="p-4 font-mono text-center">-</td>
                        <td class="p-4 font-mono text-center">-</td>
                         <td class="p-4 text-right flex justify-end gap-2">
                             <button onclick="openRoleModal(${m.id}, '${m.role}')" class="text-slate-500 hover:bg-gray-100 p-1 rounded" title="Rol"><i data-lucide="shield" class="w-4 h-4"></i></button>
                             <button onclick="toggleUserStatus(${m.id}, '${m.status}')" class="text-slate-500 hover:bg-gray-100 p-1 rounded" title="Bloqueo"><i data-lucide="${m.status === 'blocked' ? 'unlock' : 'lock'}" class="w-4 h-4"></i></button>
                        </td>
                    </tr>
                `).join('');
            }

            // 2. Customers Section
            tbody.innerHTML += `
                <tr><td colspan="6" class="p-4 bg-slate-100 font-bold text-slate-700 text-sm uppercase tracking-wider border-y mt-4">Clientes Registrados (${customers.length})</td></tr>
            `;

            if (customers.length === 0) {
                tbody.innerHTML += '<tr><td colspan="6" class="p-8 text-center text-gray-500 italic">No hay clientes registrados aún.</td></tr>';
            } else {
                tbody.innerHTML += customers.map(m => {
                    const isExpanded = state.expandedUserId === m.id;
                    const rowClass = isExpanded ? 'bg-blue-50/50 border-l-4 border-l-slate-900' : 'bg-white hover:bg-gray-50 border-l-4 border-l-transparent';

                    // Main Row
                    let html = `
                     <tr class="border-b cursor-pointer transition-colors ${rowClass}" onclick="toggleExpandUser(${m.id})">
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-xs font-bold">
                                    ${(m.firstName || 'C').substring(0, 1).toUpperCase()}
                                </div>
                                <div class="flex flex-col">
                                    <span class="font-medium text-slate-900">${m.firstName || 'Cliente'} ${m.lastName || ''}</span>
                                    <span class="text-xs text-gray-400">${m.email}</span>
                                </div>
                            </div>
                        </td>
                        <td class="p-4"><span class="text-gray-400 text-xs">Cliente</span></td>
                        <td class="p-4">
                           ${m.bannedUntil ?
                            `<span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase bg-orange-100 text-orange-700 border border-orange-200" title="Hasta: ${new Date(m.bannedUntil).toLocaleDateString()}">Suspendido</span>`
                            : (m.status === 'active'
                                ? '<span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase bg-green-100 text-green-700 border border-green-200">Activo</span>'
                                : '<span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase bg-red-100 text-red-700 border border-red-200">Bloqueado</span>')
                        }
                        </td>
                        <td class="p-4 text-center font-bold text-slate-600 text-sm">${(m.courses || []).length}</td>
                        <td class="p-4 font-mono text-green-600 text-sm">$${(m.spent || 0).toFixed(2)}</td>
                        <td class="p-4 text-right">
                            <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 text-gray-400 inline-block transition-transform ${isExpanded ? 'rotate-180' : ''}"></i>
                        </td>
                    </tr>`;

                    // Details Row (Expanded)
                    if (isExpanded) {
                        html += `
                        <tr class="bg-gray-50 border-b shadow-inner">
                            <td colspan="6" class="p-6 cursor-default">
                                <div class="flex flex-col md:flex-row gap-8">
                                    <!-- Courses List -->
                                    <div class="flex-1">
                                        <h4 class="font-bold text-sm text-slate-700 mb-3 flex items-center gap-2">
                                            <i data-lucide="book-open" class="w-4 h-4"></i> Cursos Inscriptos (${(m.courses || []).length})
                                        </h4>
                                        <div class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                            ${(m.courses && m.courses.length > 0) ? m.courses.map(c => `
                                                <div class="flex items-center justify-between p-2 bg-white rounded border text-sm">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-8 h-8 bg-gray-200 rounded overflow-hidden">
                                                            <!-- We assume c.image might be available in course detail logic, if not fallback -->
                                                             <i data-lucide="book" class="w-4 h-4 m-2 text-gray-400"></i>
                                                        </div>
                                                        <span class="font-medium text-slate-700">${c.title || 'Curso #' + c.courseId}</span>
                                                        <span class="ml-2 text-xs font-bold ${c.progress === 100 ? 'text-green-600' : 'text-blue-600'} bg-gray-100 px-2 py-0.5 rounded">
                                                            ${c.progress || 0}%
                                                        </span>
                                                    </div>
                                                    <button onclick="event.stopPropagation(); unenrollUser(${m.id}, ${c.courseId})" class="text-xs text-red-500 hover:underline">Quitar Acceso</button>
                                                </div>
                                            `).join('') : '<p class="text-xs text-gray-400 italic">Sin cursos activos.</p>'}
                                        </div>
                                    </div>

                                    <!-- Actions Panel -->
                                    <div class="w-full md:w-64 space-y-3 pt-2">
                                        <h4 class="font-bold text-sm text-slate-700 mb-2">Acciones de Gestión</h4>
                                        
                                        <button onclick="event.stopPropagation(); openBanModal(${m.id})" class="w-full flex items-center justify-between px-3 py-2 bg-white border border-orange-200 text-orange-600 rounded hover:bg-orange-50 transition text-sm">
                                            <span><i data-lucide="clock" class="w-4 h-4 inline mr-2"></i> Banear Temporalmente</span>
                                        </button>

                                        ${m.status === 'blocked' ?
                                `<button onclick="event.stopPropagation(); toggleUserStatus(${m.id}, 'blocked')" class="w-full flex items-center justify-between px-3 py-2 bg-white border border-green-200 text-green-600 rounded hover:bg-green-50 transition text-sm">
                                                <span><i data-lucide="unlock" class="w-4 h-4 inline mr-2"></i> Desbloquear Usuario</span>
                                            </button>` :
                                `<button onclick="event.stopPropagation(); toggleUserStatus(${m.id}, 'active')" class="w-full flex items-center justify-between px-3 py-2 bg-white border border-red-200 text-red-600 rounded hover:bg-red-50 transition text-sm">
                                                <span><i data-lucide="lock" class="w-4 h-4 inline mr-2"></i> Bloquear (Indefinido)</span>
                                            </button>`
                            }

                                        <button onclick="event.stopPropagation(); deleteUser(${m.id}, '${m.email}')" class="w-full flex items-center justify-between px-3 py-2 bg-white border border-red-200 text-red-600 rounded hover:bg-red-50 transition text-sm mt-4">
                                            <span><i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i> Eliminar Usuario</span>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>`;
                    }
                    return html;
                }).join('');
            }
            lucide.createIcons();
        }

        // EXPAND HANDLER
        function toggleExpandUser(userId) {
            // Toggle
            if (state.expandedUserId === userId) state.expandedUserId = null;
            else state.expandedUserId = userId;
            renderMembers();
        }

        // BAN LOGIC
        function openBanModal(userId) {
            document.getElementById('ban-user-id').value = userId;
            document.getElementById('ban-duration').value = '1440'; // Default 24h
            document.getElementById('ban-modal').showModal();
        }

        async function confirmBan() {
            const userId = document.getElementById('ban-user-id').value;
            const minutes = parseInt(document.getElementById('ban-duration').value);

            if (!userId) return;

            const banDate = new Date();
            banDate.setMinutes(banDate.getMinutes() + minutes);

            try {
                await window.API.apiBanUser(userId, banDate.toISOString());
                showToast("Usuario baneado temporalmente", "success");
                document.getElementById('ban-modal').close();
                // Refresh
                state.members = await window.API.apiGetAllUsers();
                renderMembers();
            } catch (e) {
                showToast("Error al banear usuario", "error");
            }
        }

        async function deleteUser(id, email) {
            if (!confirm(`⚠️ PELIGRO ⚠️\n\nEstás a punto de eliminar al usuario ${email}.\nSe perderán todos sus cursos, progreso y compras.\n\n¿Estás seguro?`)) return;
            try {
                await window.API.apiDeleteUser(id);
                showToast("Usuario eliminado permanentemente", "success");
                state.members = await window.API.apiGetAllUsers();
                renderMembers();
            } catch (e) { showToast("Error al eliminar", "error"); }
        }

        function filterMembers(query) {
            const lower = query.toLowerCase();
            const filtered = state.members.filter(m =>
                (m.firstName + ' ' + m.lastName).toLowerCase().includes(lower) ||
                m.email.toLowerCase().includes(lower)
            );
            renderMembers(filtered);
        }

        async function toggleMemberStatus(id, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'blocked' : 'active';
            try {
                await window.API.apiUpdateMemberStatus(id, newStatus);
                showToast(`Usuario ${newStatus === 'active' ? 'activado' : 'bloqueado'} `, 'success');
                // Reload
                state.members = await window.API.apiGetAllUsers();
                renderMembers();
            } catch (e) { showToast("Error actualizando usuario", "error"); }
        }

        // User Creation & Role Mgmt
        function openCreateUserModal() {
            document.getElementById('new-user-firstname').value = '';
            document.getElementById('new-user-lastname').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-password').value = '';
            document.getElementById('create-user-modal').showModal();
        }

        async function createNewUser() {
            const first = document.getElementById('new-user-firstname').value;
            const last = document.getElementById('new-user-lastname').value;
            const email = document.getElementById('new-user-email').value;
            const pass = document.getElementById('new-user-password').value;
            const role = document.getElementById('new-user-role').value;

            if (!email || !pass) return showToast("Email y contraseña requeridos", "error");

            try {
                await window.API.apiCreateUser({ firstName: first, lastName: last, email: email, password: pass, role: role });
                showToast("Usuario creado correctamente", "success");
                document.getElementById('create-user-modal').close();
                state.members = await window.API.apiGetAllUsers();
                renderMembers();
            } catch (e) {
                showToast("Error: " + e.message, "error");
            }
        }

        function openRoleModal(id, role) {
            document.getElementById('edit-role-userid').value = id;
            document.getElementById('edit-role-select').value = role || 'user';
            document.getElementById('role-modal').showModal();
        }

        async function confirmRoleChange() {
            const id = document.getElementById('edit-role-userid').value;
            const role = document.getElementById('edit-role-select').value;
            try {
                await window.API.apiUpdateUserRole(id, role);
                showToast("Rol actualizado", "success");
                document.getElementById('role-modal').close();
                state.members = await window.API.apiGetAllUsers();
                renderMembers();
            } catch (e) { showToast("Error al actualizar rol", "error"); }
        }

        // --- COMENTARIOS ---
        async function renderComments() {
            try {
                const comments = await window.API.apiGetAllComments();
                const tbody = document.getElementById('comments-table-body');
                tbody.innerHTML = comments.map(c => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-4">
                            <div class="font-medium text-slate-900">${c.firstName || 'Usuario'} ${c.lastName || ''}</div>
                            <div class="text-xs text-gray-500">${c.email || 'Sin email'}</div>
                        </td>
                        <td class="p-4 text-sm text-gray-600 max-w-xs truncate" title="${c.content}">${c.content}</td>
                        <td class="p-4 text-xs">
                            <div class="font-medium">${c.courseTitle || 'Curso #' + c.courseId}</div>
                            <div class="text-gray-500">Lección ${c.lessonId}</div>
                        </td>
                        <td class="p-4 text-xs text-gray-500">${new Date(c.createdAt).toLocaleDateString()}</td>
                        <td class="p-4 text-right space-x-2">
                            <button onclick="openReplyModal('${c.courseId}', '${c.lessonId}', '${c.firstName} ${c.lastName}')"
                                class="text-blue-600 hover:bg-blue-50 p-1 rounded" title="Responder">
                                <i data-lucide="reply" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteComment(${c.id})"
                                class="text-red-600 hover:bg-red-50 p-1 rounded" title="Eliminar">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
            `).join('');
                lucide.createIcons();
            } catch (e) { console.error(e); }
        }

        async function deleteComment(id) {
            if (!confirm("¿Eliminar comentario?")) return;
            try {
                await window.API.apiDeleteComment(id);
                showToast("Comentario eliminado", "success");
                renderComments();
            } catch (e) { showToast("Error al eliminar", "error"); }
        }

        function openReplyModal(courseId, lessonId, userName) {
            document.getElementById('reply-course-id').value = courseId;
            document.getElementById('reply-lesson-id').value = lessonId;
            document.getElementById('reply-content').value = `@${userName} `; // Pre-fill with mention
            document.getElementById('reply-modal').showModal();
        }

        async function sendReply() {
            const courseId = document.getElementById('reply-course-id').value;
            const lessonId = document.getElementById('reply-lesson-id').value;
            const content = document.getElementById('reply-content').value;

            if (!content) return showToast("Escribe una respuesta", "error");

            try {
                // Admin replies as themselves (need to be logged in effectively)
                // We use apiPostComment which uses local currentUser.
                // Admin panel usually has Admin logged in.
                // FIX: Use global state.currentUser which is validated on load
                // This prevents "identity crossing" if localStorage has a client session
                const adminId = state.currentUser ? state.currentUser.id : null;
                if (!adminId) return showToast("Error de sesión: Recarga la página", "error");

                await window.API.apiPostComment({
                    userId: adminId,
                    courseId,
                    lessonId,
                    content
                });
                showToast("Respuesta enviada", "success");
                document.getElementById('reply-modal').close();
                renderComments();
            } catch (e) { showToast("Error enviando respuesta", "error"); }
        }

        // --- END HELPERS ---

        // CARGAR TODOS LOS DATOS DEL ADMIN
        window.loadAdminData = async function () {
            try {
                // Fetch basic data
                const [categories, courses, coupons, members, resources] = await Promise.all([
                    window.API.apiGetCategories(),
                    window.API.apiGetAllCourses(),
                    window.API.apiGetCoupons(),
                    window.API.apiGetAllUsers(),
                    window.API.apiGetResources()
                ]);

                state.categories = categories || [];
                state.courses = courses || [];
                state.coupons = coupons || [];
                state.members = members || [];
                state.resources = resources || [];

                // Fetch Metrics (New Endpoint)
                try {
                    state.metrics = await window.API.apiGetAdminMetrics();
                } catch (e) {
                    console.error("Error fetching metrics", e);
                    state.metrics = {}; // Empty fallback
                }

                console.log('✅ Admin data loaded');

                // Initialize Dashboard if that's the current view
                updateDashboard(state.metrics);
                initChart(state.metrics);

            } catch (err) {
                console.error('❌ Error loading admin data:', err);
                showToast('Error cargando datos', 'error');
            }
        };

        // NEW: User Controls
        async function toggleUserStatus(id, currentStatus) {
            const newStatus = currentStatus === 'blocked' ? 'active' : 'blocked';
            if (!confirm(`¿${newStatus === 'blocked' ? 'Bloquear' : 'Desbloquear'} usuario?`)) return;
            try {
                await window.API.apiUpdateUserStatus(id, newStatus);
                showToast(`Usuario ${newStatus === 'blocked' ? 'bloqueado' : 'activado'}`);
                state.members = await window.API.apiGetAllUsers();
                renderMembers();
            } catch (e) { showToast("Error al cambiar estado", "error"); }
        }

        async function openEnrollmentsModal(userId, userName) {
            const listEl = document.getElementById('enrollments-list');
            listEl.innerHTML = '<p class="text-gray-500">Cargando...</p>';
            document.getElementById('enrollments-modal').showModal();

            try {
                const enrollmentList = await window.API.apiGetUserEnrollments(userId);
                if (enrollmentList.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500 italic">No está inscrito en ningún curso.</p>`;
                } else {
                    listEl.innerHTML = enrollmentList.map(e => `
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded border">
                            <span class="text-sm font-medium">${e.title}</span>
                            <button onclick="unenrollUser(${userId}, ${e.courseId})" class="text-red-500 text-xs hover:underline">Quitar Acceso</button>
                        </div>
                    `).join('');
                }
            } catch (e) {
                listEl.innerHTML = '<p class="text-red-500">Error cargando cursos.</p>';
            }
        }

        async function unenrollUser(uid, cid) {
            if (!confirm("¿Quitar acceso al curso? El progreso se perderá.")) return;
            try {
                await window.API.apiDeleteUserEnrollment(uid, cid);
                showToast("Acceso revocado");
                // Refresh modal content
                const enrollmentList = await window.API.apiGetUserEnrollments(uid);
                // Re-render essentially... simple way is just re-call open but generic
                // Or updates manually. Let's just close/re-open logic or update HTML directly
                // Easier to just close modal to confirm action or simple reload
                document.getElementById('enrollments-modal').close();
            } catch (e) { showToast("Error revocando acceso", "error"); }
        }

        // RESOURCES PRIVACY
        async function uploadResourceForLesson(modId, lessonId, input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();

            showToast('Subiendo recurso...', 'info');

            reader.onload = async (e) => {
                const dataUrl = e.target.result;
                try {
                    // Upload with access='course' so it doesn't show in free resources
                    const result = await window.API.apiCreateResource({
                        name: file.name,
                        type: file.type,
                        description: 'Course Attachment',
                        dataUrl: dataUrl,
                        access: 'course'
                    });

                    if (result && result.id) {
                        const mod = state.tempModules.find(m => m.id === modId);
                        const lesson = mod.lessons.find(l => l.id === lessonId);
                        if (!lesson.resources) lesson.resources = [];
                        lesson.resources.push({
                            id: result.id,
                            name: file.name,
                            url: `/api/resources/${result.id}/download`,
                            type: file.type
                        });
                        renderModules();
                        showToast('Recurso adjuntado', 'success');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('Error al adjuntar', 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        async function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = async function (e) {
                    const dataUrl = e.target.result;
                    try {
                        // Public resources
                        await window.API.apiCreateResource({
                            name: file.name,
                            type: file.type,
                            dataUrl: dataUrl,
                            access: 'public'
                        });
                        state.resources = await window.API.apiGetResources();
                        renderResources();
                        showToast('Recurso subido correctamente', 'success');
                    } catch (err) {
                        showToast('Error al subir recurso', 'error');
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // --- LÓGICA DE EDICIÓN Y CREACIÓN ---
        function resetAndCreateCourse() {
            state.editingCourseId = null; // Limpiar modo edición
            resetForm();
            router('create-course');
        }

        function resetForm() {
            document.getElementById('form-page-title').innerText = "Crear Nuevo Curso";
            document.getElementById('form-save-btn-text').innerText = "Guardar Curso";

            document.getElementById('course-title').value = "";
            document.getElementById('course-desc').value = "";
            document.getElementById('course-duration').value = "";
            document.getElementById('price-real').value = "";
            document.getElementById('price-offer').value = "";
            document.getElementById('course-video-promo').value = "";

            // Image Reset
            state.currentCourseImage = null;
            document.getElementById('course-cover-input').value = "";
            document.getElementById('cover-preview').src = "";
            document.getElementById('cover-preview').classList.add('hidden');
            document.getElementById('cover-overlay').classList.add('hidden');
            document.getElementById('cover-placeholder').classList.remove('hidden');

            state.tempModules = [{ id: Date.now(), title: "Módulo 1", lessons: [{ id: Date.now() + 1, title: "", url: "" }] }];
            renderModules();
            renderCategorySelect();
        }


        function editCourse(id) {
            const course = state.courses.find(c => c.id === id);
            if (!course) return;

            state.editingCourseId = id; // Activar modo edición
            state.tempModules = JSON.parse(JSON.stringify(course.modules)); // Clon profundo

            router('create-course');

            // Llenar datos
            document.getElementById('form-page-title').innerText = "Editar Curso";
            document.getElementById('form-save-btn-text').innerText = "Actualizar Curso";

            document.getElementById('course-title').value = course.title;
            document.getElementById('course-desc').value = course.desc || "";
            document.getElementById('course-duration').value = course.duration || "";
            document.getElementById('price-real').value = course.price;
            document.getElementById('price-offer').value = course.priceOffer || "";
            document.getElementById('course-video-promo').value = course.videoPromo || "";

            // Image Load
            state.currentCourseImage = course.image || null;
            if (state.currentCourseImage) {
                document.getElementById('cover-preview').src = state.currentCourseImage;
                document.getElementById('cover-preview').classList.remove('hidden');
                document.getElementById('cover-overlay').classList.remove('hidden');
                document.getElementById('cover-placeholder').classList.add('hidden');
            } else {
                document.getElementById('cover-preview').classList.add('hidden');
                document.getElementById('cover-overlay').classList.add('hidden');
                document.getElementById('cover-placeholder').classList.remove('hidden');
            }

            renderCategorySelect();
            document.getElementById('course-category').value = course.category;
            renderModules();
        }

        async function saveCourse() {
            const title = document.getElementById('course-title').value;
            const price = document.getElementById('price-real').value;
            if (!title || !price) return showToast("Falta título o precio", "error");

            // Safety: Deep Clean the URL data immediately before saving
            // This ensures even if ONCHANGE didn't fire, we save clean data
            state.tempModules.forEach(m => {
                if (m.lessons) {
                    m.lessons.forEach(l => {
                        if (l.url) l.url = l.url.trim();
                        // Also Ensure Resources are array
                        if (!l.resources) l.resources = [];
                    });
                }
            });

            const courseData = {
                title,
                price,
                desc: document.getElementById('course-desc').value,
                duration: document.getElementById('course-duration').value,
                priceOffer: document.getElementById('price-offer').value,
                videoPromo: document.getElementById('course-video-promo').value,
                image: state.currentCourseImage,
                modulesCount: state.tempModules.length,
                category: document.getElementById('course-category').value,
                modules: state.tempModules,
            };

            try {
                if (state.editingCourseId) {
                    await window.API.apiUpdateCourse(state.editingCourseId, courseData);
                    showToast("Curso actualizado correctamente", "success");
                } else {
                    await window.API.apiCreateCourse(courseData);
                    showToast("Curso creado correctamente", "success");
                }
                state.courses = await window.API.apiGetAllCourses();
                state.editingCourseId = null; // Salir modo edición
                router('courses');
            } catch (err) {
                showToast(err.message || 'Error al guardar curso', 'error');
            }
        }

        // TOGGLE STATUS
        async function toggleCourseStatus(id) {
            try {
                const course = (await window.API.apiGetAllCourses()).find(c => c.id === id);
                if (!course) return;
                const newStatus = (course.status === 'active') ? 'inactive' : 'active';
                await window.API.apiUpdateCourse(id, { status: newStatus });
                state.courses = await window.API.apiGetAllCourses();
                renderCoursesList();
                showToast(`Curso ${newStatus === 'active' ? 'Activado' : 'Desactivado'}`, 'success');
            } catch (err) { showToast('No se pudo cambiar estado', 'error'); }
        }

        async function deleteCourse(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este curso? Esta acción no se puede deshacer.')) return;
            try {
                await window.API.apiDeleteCourse(id);
                state.courses = await window.API.apiGetAllCourses();
                renderCoursesList();
                showToast('Curso eliminado correctamente', 'success');
            } catch (err) {
                console.error(err);
                showToast('Error al eliminar curso', 'error');
            }
        }

        function handleCourseCoverUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    state.currentCourseImage = e.target.result;
                    const preview = document.getElementById('cover-preview');
                    preview.src = state.currentCourseImage;
                    preview.classList.remove('hidden');
                    document.getElementById('cover-placeholder').classList.add('hidden');
                    document.getElementById('cover-overlay').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // AUTH - Esperar a que API esté listo
        function initLoginHandler() {
            // Deprecated - moved to separate script tag at end of body
        }

        function logout() {
            state.currentUser = null;
            if (window.API && window.API.apiLogout) window.API.apiLogout();
            document.getElementById('app-layout').classList.add('hide');
            document.getElementById('login-view').classList.remove('hide');
            showToast("Sesión cerrada");
        }
        function togglePassword() {
            const input = document.getElementById('password');
            input.type = input.type === "password" ? "text" : "password";
        }

        // DASHBOARD
        function updateDashboard(metrics) {
            if (!metrics) return;
            document.getElementById('kpi-revenue').textContent = '$' + (metrics.revenue || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('kpi-students').textContent = '+' + (metrics.students || 0);

            // Fix: Use salesThisMonth from API, or fallback to 0. Do NOT use recentSales.length.
            const monthSales = metrics.salesThisMonth !== undefined ? metrics.salesThisMonth : 0;
            document.getElementById('month-sales').textContent = '+' + monthSales;

            document.getElementById('kpi-active-courses').textContent = metrics.activeCourses || 0;
        }

        function initChart(metrics) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (window.myChart) window.myChart.destroy();

            const monthlyData = metrics.monthlyRevenue || new Array(12).fill(0);
            const monthLabels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Ingresos ($)',
                        data: monthlyData,
                        backgroundColor: '#0f172a',
                        borderColor: '#1e293b',
                        borderRadius: 4,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => '$' + value.toFixed(0) }
                        }
                    },
                    plugins: { legend: { display: true } }
                }
            });

            // Recent Sales
            const recentOrders = metrics.recentSales || [];
            document.getElementById('recent-sales-list').innerHTML = recentOrders.length > 0 ? recentOrders.map(order => `
                    <div class="flex items-center justify-between p-2 border rounded hover:bg-gray-50">
                        <div class="flex items-center gap-3">
                            <div class="h-8 w-8 rounded-full bg-slate-200 flex items-center justify-center font-bold text-xs">
                                ${(order.firstName || 'C').substring(0, 1).toUpperCase()}
                            </div>
                            <div>
                                <p class="text-sm font-medium">${order.firstName || 'Cliente'} ${order.lastName || ''}</p>
                                <p class="text-xs text-gray-400">#${order.id}</p>
                            </div>
                        </div>
                        <span class="font-bold text-sm text-green-600">+$${parseFloat(order.total).toFixed(2)}</span>
                    </div>
            `).join('') : '<p class="text-gray-400 text-center py-4 text-sm">Sin ventas recientes</p>';
        }

        function _get(key, fallback) {
            try {
                const v = localStorage.getItem(key);
                return v ? JSON.parse(v) : fallback;
            } catch (e) {
                return fallback;
            }
        }

        // CURSOS Y MÓDULOS (Helpers)
        function getVideoThumbnail(url) {
            if (!url) return 'https://placehold.co/600x400?text=Sin+Video';
            const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/user\/\S+|\/ytscreeningroom\?v=))([\w\-]{10,12})\b/);
            if (ytMatch && ytMatch[1]) return `https://img.youtube.com/vi/${ytMatch[1]}/hqdefault.jpg`;
            return 'https://placehold.co/600x400?text=Video+Link';
        }

        function renderModules() {
            document.getElementById('modules-container').innerHTML = state.tempModules.map(mod => `
                <div class="border rounded-lg p-4 bg-gray-50">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex gap-2 items-center flex-1"><i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400 cursor-move"></i><input type="text" value="${mod.title}" onchange="updateModTitle(${mod.id}, this.value)" class="bg-transparent font-medium border-none focus:ring-0 p-0 w-full"></div>
                        <button onclick="deleteModule(${mod.id})" class="text-red-500 hover:bg-red-100 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <div class="pl-6 space-y-4 border-l-2 border-gray-200 ml-2 lessons-list" data-mod-id="${mod.id}">
                        ${mod.lessons.map(lesson => `
                            <div class="bg-white p-3 rounded border shadow-sm group">
                                <div class="flex gap-3 items-start mb-3">
                                    <div class="cursor-move-lesson p-1 mr-2 text-gray-300 hover:text-gray-500 self-center"><i data-lucide="grip-vertical" class="w-4 h-4"></i></div>
                                    <div class="w-24 h-14 bg-gray-100 rounded overflow-hidden flex-shrink-0 relative video-thumbnail">
                                        <img src="${getVideoThumbnail(lesson.url)}" alt="Thumbnail">
                                        ${lesson.url ? '<div class="play-icon-overlay"><i data-lucide="play" class="w-4 h-4 text-white"></i></div>' : ''}
                                    </div>
                                    <div class="flex-1 space-y-1">
                                        <input placeholder="Título de la clase" value="${lesson.title}" onchange="updateLesson(${mod.id}, ${lesson.id}, 'title', this.value)" class="w-full p-1 border rounded text-sm font-semibold">
                                        <input placeholder="URL del video (YouTube)" value="${lesson.url}" onchange="updateLesson(${mod.id}, ${lesson.id}, 'url', this.value)" class="w-full p-1 border rounded text-xs font-mono text-gray-500">
                                    </div>
                                    <button onclick="deleteLesson(${mod.id}, ${lesson.id})" class="text-red-400 hover:text-red-600"><i data-lucide="x" class="w-4 h-4"></i></button>
                                </div>

                                <!-- Resources Section -->
                                <div class="border-t pt-2 mt-2">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs font-medium text-gray-500">Recursos Descargables</span>
                                        <label class="cursor-pointer text-xs text-blue-600 hover:underline flex items-center">
                                            <i data-lucide="upload" class="w-3 h-3 mr-1"></i> Adjuntar
                                            <input type="file" class="hidden" onchange="uploadResourceForLesson(${mod.id}, ${lesson.id}, this)">
                                        </label>
                                    </div>
                                    <div class="space-y-1">
                                        ${(lesson.resources || []).map(res => `
                                            <div class="flex justify-between items-center text-xs bg-gray-50 p-1 rounded border">
                                                <div class="flex items-center gap-2 overflow-hidden">
                                                     <i data-lucide="file" class="w-3 h-3 text-gray-400 flex-shrink-0"></i>
                                                     <a href="${res.url}" target="_blank" class="truncate hover:text-blue-600 max-w-[150px]">${res.name}</a>
                                                </div>
                                                <button onclick="deleteResourceFromLesson(${mod.id}, ${lesson.id}, '${res.id}')" class="text-red-500 hover:text-red-700 p-0.5"><i data-lucide="x" class="w-3 h-3"></i></button>
                                            </div>
                                        `).join('')}
                                        ${(!lesson.resources || lesson.resources.length === 0) ? '<p class="text-[10px] text-gray-400 italic">Sin recursos adjuntos</p>' : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        <button onclick="addLesson(${mod.id})" class="text-xs text-blue-600 hover:underline flex items-center mt-2"><i data-lucide="plus" class="w-3 h-3 mr-1"></i> Agregar Video</button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();

            // Initialize Sortable for Modules
            const modulesContainer = document.getElementById('modules-container');
            if (modulesContainer) {
                new Sortable(modulesContainer, {
                    animation: 150,
                    handle: '.cursor-move',
                    onEnd: function (evt) {
                        const itemEl = evt.item;
                        const newIndex = evt.newIndex;
                        const oldIndex = evt.oldIndex;

                        // Move in array
                        if (newIndex !== oldIndex && state.tempModules) {
                            const movedItem = state.tempModules.splice(oldIndex, 1)[0];
                            state.tempModules.splice(newIndex, 0, movedItem);
                        }
                    }
                });
            }

            // Initialize Sortable for Lessons within each module
            document.querySelectorAll('.lessons-list').forEach(list => {
                new Sortable(list, {
                    animation: 150,
                    handle: '.cursor-move-lesson',
                    group: 'lessons',
                    onEnd: function (evt) {
                        const modId = parseInt(evt.to.dataset.modId);
                        const newIndex = evt.newIndex;
                        const oldIndex = evt.oldIndex;

                        const mod = state.tempModules.find(m => m.id === modId);
                        if (mod && newIndex !== oldIndex) {
                            const movedItem = mod.lessons.splice(oldIndex, 1)[0];
                            mod.lessons.splice(newIndex, 0, movedItem);
                        }
                    }
                });
            });
        }
        function addModule() { state.tempModules.push({ id: Date.now(), title: "Nuevo Módulo", lessons: [] }); renderModules(); }
        function deleteModule(id) { state.tempModules = state.tempModules.filter(m => m.id !== id); renderModules(); }
        function updateModTitle(id, val) { state.tempModules.find(m => m.id === id).title = val; }
        function addLesson(modId) { state.tempModules.find(m => m.id === modId).lessons.push({ id: Date.now(), title: "", url: "", resources: [] }); renderModules(); }
        function deleteLesson(modId, lessonId) { const mod = state.tempModules.find(m => m.id === modId); mod.lessons = mod.lessons.filter(l => l.id !== lessonId); renderModules(); }
        function updateLesson(modId, lessonId, field, value) {
            const mod = state.tempModules.find(m => m.id === modId);
            // Sanitize URL input automatically
            const finalValue = field === 'url' ? value.trim() : value;
            mod.lessons = mod.lessons.map(l => l.id === lessonId ? { ...l, [field]: finalValue } : l);
            if (field === 'url') renderModules();
        }

        // NEW: Resource Logic specific for lessons
        async function uploadResourceForLesson(modId, lessonId, input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();

            showToast('Subiendo recurso...', 'info');

            reader.onload = async (e) => {
                const dataUrl = e.target.result;
                try {
                    // 1. Upload to centralized Resource table first
                    const result = await window.API.apiCreateResource({
                        name: file.name,
                        type: file.type,
                        description: 'Course Attachment',
                        dataUrl: dataUrl
                    });

                    if (result && result.id) {
                        // 2. Add reference to local state lesson
                        const mod = state.tempModules.find(m => m.id === modId);
                        const lesson = mod.lessons.find(l => l.id === lessonId);

                        if (!lesson.resources) lesson.resources = [];
                        lesson.resources.push({
                            id: result.id, // Store DB ID to reference
                            name: file.name,
                            url: `/api/resources/${result.id}/download`,
                            type: file.type
                        });

                        renderModules();
                        showToast('Recurso adjuntado', 'success');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('Error al adjuntar', 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        function deleteResourceFromLesson(modId, lessonId, resId) {
            const mod = state.tempModules.find(m => m.id === modId);
            const lesson = mod.lessons.find(l => l.id === lessonId);
            if (lesson && lesson.resources) {
                lesson.resources = lesson.resources.filter(r => r.id != resId);
                renderModules();
            }
        }


        // CATEGORÍAS
        function renderCategorySelect() {
            document.getElementById('course-category').innerHTML = `<option value="">Seleccionar...</option>` + state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('category-list-ui').innerHTML = state.categories.map(c => `<li class="flex justify-between items-center bg-white p-1 rounded border">${c} <button onclick="removeCategory('${c}')" class="text-red-500 hover:text-red-700"><i data-lucide="x" class="w-3 h-3"></i></button></li>`).join('');
            lucide.createIcons();
        }
        function toggleCategoryModal() { document.getElementById('category-manager').classList.toggle('hidden'); }
        async function addCategory() { const val = document.getElementById('new-cat-input').value.trim(); if (!val) return; try { await window.API.apiAddCategory(val); document.getElementById('new-cat-input').value = ''; state.categories = await window.API.apiGetCategories(); renderCategorySelect(); showToast('Categoría agregada', 'success'); } catch (err) { showToast('No se pudo agregar categoría', 'error'); } }
        async function removeCategory(val) { try { await window.API.apiDeleteCategory(val); state.categories = await window.API.apiGetCategories(); renderCategorySelect(); showToast('Categoría eliminada', 'success'); } catch (err) { showToast('No se pudo eliminar categoría', 'error'); } }

        // RENDER CURSOS LISTA (Con Botón Editar Activo)
        function renderCoursesList() {
            document.getElementById('courses-list-container').innerHTML = state.courses.map(c => {
                const isInactive = c.status === 'inactive';
                const statusBadge = !isInactive
                    ? `<span class="text-[10px] bg-green-100 text-green-700 border border-green-200 px-2 py-0.5 rounded-full font-bold uppercase">Activo</span>`
                    : `<span class="text-[10px] bg-gray-100 text-gray-500 border border-gray-200 px-2 py-0.5 rounded-full font-bold uppercase">Inactivo</span>`;
                const opacityClass = isInactive ? 'opacity-75' : '';

                const imageHtml = c.image
                    ? `<div class="h-32 w-full overflow-hidden mb-3 rounded border bg-gray-100 group"><img src="${c.image}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500"></div>`
                    : `<div class="h-32 w-full bg-slate-100 mb-3 rounded border flex items-center justify-center text-gray-300"><i data-lucide="image" class="w-8 h-8"></i></div>`;

                return `
                <div class="bg-white p-4 rounded-lg border shadow-sm flex flex-col justify-between h-auto ${opacityClass} transition-all hover:shadow-md">
                    <div>
                        ${imageHtml}
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-600 inline-block">${c.category || 'Sin cat.'}</span>
                            ${statusBadge}
                        </div>
                        <h3 class="font-bold text-lg leading-tight mb-1">${c.title}</h3>
                        <div class="flex items-center gap-2 text-xs text-gray-500 mb-2">
                             <span>${c.modulesCount} Módulos</span>
                             ${c.duration ? `<span>• ${c.duration}</span>` : ''}
                        </div>
                        <p class="text-xs text-gray-400 mb-4 line-clamp-2">${c.desc || ''}</p>
                    </div>
                    <div>
                         <div class="font-bold text-lg mb-3">$${c.price}</div>
                                 <div class="flex gap-2 pt-3 border-t">
                            <button onclick="editCourse(${c.id})" class="flex-1 flex items-center justify-center gap-1 text-sm bg-gray-50 hover:bg-gray-100 text-slate-700 py-1.5 rounded border transition">
                                <i data-lucide="pencil" class="w-3 h-3"></i> Editar
                            </button>
                            <button onclick="toggleCourseStatus(${c.id})" class="flex-1 flex items-center justify-center gap-1 text-sm ${!isInactive ? 'text-red-600 hover:bg-red-50 border-red-100' : 'text-green-600 hover:bg-green-50 border-green-100'} py-1.5 rounded border transition">
                                <i data-lucide="power" class="w-3 h-3"></i> ${!isInactive ? 'Desactivar' : 'Activar'}
                            </button>
                            <button onclick="deleteCourse(${c.id})" class="flex-1 flex items-center justify-center gap-1 text-sm text-red-600 hover:bg-red-50 border-red-100 py-1.5 rounded border transition">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }


        // --- RESCUED FUNCTIONS (Cleaned) ---

        // CUPONES
        function openCouponModal() { document.getElementById('coupon-modal').showModal(); }
        function generateCode() { document.getElementById('coupon-code').value = Math.random().toString(36).substring(2, 10).toUpperCase(); }

        async function saveCoupon() {
            const code = document.getElementById('coupon-code').value.trim().toUpperCase();
            const discount = Number(document.getElementById('coupon-discount').value) || 0;
            if (!code || discount <= 0) return showToast('Código y descuento requeridos', 'error');
            if (discount > 100) return showToast('Descuento no puede ser mayor a 100%', 'error');
            try {
                await window.API.apiCreateCoupon({
                    code: code,
                    discount: discount,
                    type: 'percentage',
                    status: 'active',
                    maxUses: 0,
                    usedCount: 0,
                    minPurchase: 0
                });
                document.getElementById('coupon-modal').close();
                document.getElementById('coupon-code').value = '';
                document.getElementById('coupon-discount').value = '';
                state.coupons = await window.API.apiGetCoupons();
                renderCoupons();
                showToast('✓ Cupón creado: ' + code, 'success');
            } catch (err) {
                showToast('Error: ' + (err.message || 'No se pudo crear cupón'), 'error');
            }
        }

        function renderCoupons() {
            const tbody = document.getElementById('coupons-table-body');
            if (!state.coupons || state.coupons.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">No hay cupones creados</td></tr>';
                return;
            }
            tbody.innerHTML = (state.coupons || []).map(c => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-mono font-bold text-slate-700">${c.code}</td>
                    <td class="p-4 font-bold text-green-600">-${c.discount}%</td>
                    <td class="p-4"><span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full border border-green-200">Activo</span></td>
                    <td class="p-4 text-right">
                        <button onclick="deleteCoupon(${c.id})" class="text-red-500 hover:bg-red-50 p-2 rounded transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function deleteCoupon(id) {
            if (!confirm('¿Eliminar cupón?')) return;
            try {
                await window.API.apiDeleteCoupon(id);
                state.coupons = await window.API.apiGetCoupons();
                renderCoupons();
                showToast('Cupón eliminado');
            } catch (err) { showToast('Error al eliminar'); }
        }

        // PASSWORD & ROLES
        function openChangePasswordModal(id, name) {
            document.getElementById('pwd-user-id').value = id;
            document.getElementById('pwd-user-name').textContent = name;
            document.getElementById('new-user-pwd').value = '';
            document.getElementById('change-password-modal').showModal();
        }

        async function confirmChangePassword() {
            const id = document.getElementById('pwd-user-id').value;
            const pwd = document.getElementById('new-user-pwd').value;
            if (!pwd || pwd.length < 6) return showToast("Mínimo 6 caracteres", "error");

            try {
                const res = await fetch(`/api/users/${id}/password-force`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pwd })
                });
                if (res.ok) {
                    showToast("Contraseña actualizada", "success");
                    document.getElementById('change-password-modal').close();
                } else {
                    const d = await res.json();
                    showToast(d.error || "Error al actualizar", "error");
                }
            } catch (e) { showToast("Error de conexión", "error"); }
        }

        async function promoteToStaff(id) {
            if (!confirm('¿Promover usuario a administrador?')) return;
            try {
                await window.API.apiUpdateUserRole(id, 'admin');
                showToast('Usuario promovido');
                state.members = await window.API.apiGetAllUsers();
                renderMembers();
            } catch (e) { showToast('Error al promover'); }
        }

        async function assignMembership(userId) {
            if (!confirm('¿Asignar membresía completa gratis?')) return;
            // Logic missing in original snippet but preserving function
            showToast('Función no implementada en backend actual', 'info');
        }

        // COMMENTS MANAGEMENT
        let state_comments = [];
        let state_replyToComment = null;

        async function renderComments() {
            try {
                state_comments = await window.API.apiGetAllComments();
                const tbody = document.getElementById('comments-table-body');

                if (!state_comments || state_comments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500">No hay comentarios aún</td></tr>';
                    return;
                }

                tbody.innerHTML = state_comments.map(c => {
                    const userName = `${c.firstName || ''} ${c.lastName || ''}`.trim() || c.email;
                    const courseTitle = c.courseTitle || 'Curso desconocido';
                    const date = new Date(c.createdAt).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });
                    const hasReplies = c.replies && c.replies.length > 0;
                    const repliesCount = hasReplies ? c.replies.length : 0;

                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4">
                                <div class="font-medium text-sm">${userName}</div>
                                <div class="text-xs text-gray-400">${c.email}</div>
                            </td>
                            <td class="p-4">
                                <div class="text-sm mb-1">${c.content.substring(0, 100)}${c.content.length > 100 ? '...' : ''}</div>
                                ${hasReplies ? `
                                    <div class="mt-2 p-2 bg-blue-50 border-l-2 border-blue-300 rounded text-xs">
                                        <div class="font-semibold text-blue-700 mb-1">Has respondido (${repliesCount} ${repliesCount === 1 ? 'respuesta' : 'respuestas'})</div>
                                        ${c.replies.map(r => `
                                            <div class="text-gray-600 italic">"${r.content.substring(0, 60)}..."</div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </td>
                            <td class="p-4 truncate max-w-xs text-xs">${courseTitle}</td>
                            <td class="p-4 text-xs text-gray-500">${date}</td>
                            <td class="p-4 text-right">
                                <button onclick="openReplyModal(${c.id}, ${c.courseId}, ${c.lessonId}, '${userName.replace(/'/g, "\\'")}')" 
                                    class="text-blue-600 hover:bg-blue-50 p-2 rounded transition mr-2" title="Responder">
                                    <i data-lucide="message-circle" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteComment(${c.id})" 
                                    class="text-red-500 hover:bg-red-50 p-2 rounded transition" title="Eliminar">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                lucide.createIcons();
            } catch (err) {
                console.error('Error loading comments:', err);
                showToast('Error al cargar comentarios', 'error');
            }
        }

        function openReplyModal(commentId, courseId, lessonId, userName) {
            state_replyToComment = commentId;
            document.getElementById('reply-course-id').value = courseId;
            document.getElementById('reply-lesson-id').value = lessonId;
            document.getElementById('reply-content').value = '';
            document.getElementById('reply-modal').showModal();
        }

        async function sendReply() {
            const courseId = document.getElementById('reply-course-id').value;
            const lessonId = document.getElementById('reply-lesson-id').value;
            const content = document.getElementById('reply-content').value.trim();

            if (!content) {
                showToast('Escribe una respuesta', 'error');
                return;
            }

            try {
                const user = await window.API.apiGetProfile();
                if (!user) throw new Error('Usuario no autenticado');

                await window.API.apiPostComment({
                    userId: user.id,
                    courseId: parseInt(courseId),
                    lessonId: parseInt(lessonId),
                    content: content,
                    parentId: state_replyToComment  // This links it as a reply
                });

                document.getElementById('reply-modal').close();
                showToast('Respuesta enviada correctamente', 'success');
                await renderComments();  // Refresh the list
            } catch (err) {
                console.error('Error sending reply:', err);
                showToast('Error al enviar respuesta', 'error');
            }
        }

        async function deleteComment(id) {
            if (!confirm('¿Eliminar este comentario?')) return;
            try {
                await window.API.apiDeleteComment(id);
                showToast('Comentario eliminado', 'success');
                await renderComments();
            } catch (err) {
                console.error('Error deleting comment:', err);
                showToast('Error al eliminar comentario', 'error');
            }
        }


        // TOAST SYSTEM
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return console.warn('No toast container');
            const el = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-slate-800');
            el.className = `${colors} text-white px-4 py-3 rounded shadow-lg text-sm flex items-center gap-2 transform transition-all duration-300 translate-y-10 opacity-0`;
            el.innerHTML = `<span>${msg}</span>`;
            container.appendChild(el);
            requestAnimationFrame(() => { el.classList.remove('translate-y-10', 'opacity-0'); });
            setTimeout(() => {
                el.classList.add('opacity-0', 'translate-y-10');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // APP INIT
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                const user = await window.API.apiLogin(email, pass);
                if (user && (user.role === 'admin' || user.role === 'editor')) {
                    state.currentUser = user;
                    document.getElementById('login-view').classList.add('hide');
                    document.getElementById('app-layout').classList.remove('hide');
                    loadAdminData();
                    router('dashboard');
                    showToast(`Bienvenido Admin ${user.firstName}`, 'success');
                } else {
                    showToast('Acceso denegado: No eres administrador', 'error');
                }
            } catch (err) {
                showToast(err.message || 'Error de autenticación', 'error');
            }
        });

        lucide.createIcons();
    </script>

    <!-- Change Password Modal -->
    <dialog id="change-password-modal" class="p-6 rounded-lg border border-gray-200 shadow-xl backdrop:bg-black/50">
        <h3 class="text-lg font-bold mb-4">Cambiar Contraseña</h3>
        <p class="text-sm text-gray-500 mb-4">Usuario: <span id="pwd-user-name" class="font-bold"></span></p>
        <input type="hidden" id="pwd-user-id">
        <div class="space-y-3">
            <input type="password" id="new-user-pwd" placeholder="Nueva contraseña"
                class="w-full p-2 border rounded text-sm">
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="document.getElementById('change-password-modal').close()"
                    class="px-3 py-1.5 text-sm text-gray-500 hover:text-gray-700">Cancelar</button>
                <button onclick="confirmChangePassword()"
                    class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">Guardar</button>
            </div>
        </div>
    </dialog>
</body>

</html>