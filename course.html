<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Curso | Gonzalo Juárez López Jr.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brandPink: '#ec4899',
                        brandPinkHover: '#db2777',
                        bgDark: '#0a0a0a',
                        cardDark: '#171717',
                        borderDark: '#262626'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Anti-Piracy Overlay for Video */
        .video-protection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            background: transparent;
            pointer-events: none;
        }

        [x-cloak] {
            display: none !important;
        }
    </style>
    <script>
        // Anti-Piracy Script
        document.addEventListener('contextmenu', event => event.preventDefault());

        document.addEventListener('keydown', function (e) {
            // Block F12, Ctrl+Shift+I, PrintScreen, Ctrl+S, Ctrl+U
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || e.key === 'PrintScreen' || (e.ctrlKey && (e.key === 's' || e.key === 'S')) || (e.ctrlKey && (e.key === 'u' || e.key === 'U'))) {
                e.preventDefault();
                if (e.key === 'PrintScreen') navigator.clipboard.writeText('');
            }
        });
    </script>
</head>

<body x-data="courseViewer()" x-init="init()" class="min-h-screen flex flex-col bg-bgDark text-white">

    <!-- Header -->
    <header
        class="h-16 border-b border-borderDark flex items-center justify-between px-4 lg:px-6 bg-bgDark z-30 sticky top-0">
        <div class="flex items-center gap-4">
            <a href="panel.html"
                class="p-2 hover:bg-white/5 rounded-full transition-colors text-zinc-400 hover:text-white">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                </svg>
            </a>
            <h1 class="font-bold text-sm lg:text-base truncate max-w-[200px] sm:max-w-md text-white tracking-wide"
                x-text="course ? course.title : 'Cargando...'"></h1>
        </div>

        <!-- Toggle Mobile Menu -->
        <button @click="mobileMenuOpen = !mobileMenuOpen" class="lg:hidden p-2 text-zinc-400 hover:text-white">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12h18M3 6h18M3 18h18" />
            </svg>
        </button>

        <div class="hidden lg:flex items-center gap-4">
            <div class="text-xs text-zinc-400 font-medium">
                Tu progreso: <span class="text-white" x-text="progress + '%'"></span>
            </div>
            <div class="w-32 h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                <div class="h-full bg-brandPink transition-all duration-500 ease-out"
                    :style="'width: ' + progress + '%'"></div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 lg:grid lg:grid-cols-12 h-[calc(100vh-64px)] overflow-hidden">

        <!-- Left Column: Video & Tabs (Adaptive Scroll) -->
        <main class="lg:col-span-9 flex flex-col h-full overflow-y-auto relative scrollbar-hide">

            <!-- Video Container (Theater Mode) -->
            <div
                class="w-full bg-black relative shrink-0 shadow-2xl flex justify-center bg-zinc-900 border-b border-zinc-800">
                <div class="w-full max-w-5xl aspect-video relative shadow-lg">
                    <template x-if="currentLesson">
                        <div class="w-full h-full relative" oncontextmenu="return false;">
                            <div class="video-protection-overlay"></div>

                            <!-- Iframe Handling -->
                            <div x-show="isIframe(currentLesson.url)" x-html="currentLesson.url"
                                class="w-full h-full absolute inset-0 [&>iframe]:w-full [&>iframe]:h-full border-none">
                            </div>

                            <iframe x-show="!isIframe(currentLesson.url) && getEmbedUrl(currentLesson.url)"
                                :src="getEmbedUrl(currentLesson.url)" class="w-full h-full absolute inset-0"
                                frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>

                            <div class="video-protection-overlay" @contextmenu.prevent></div>

                            <!-- Fallback -->
                            <div x-show="!currentLesson.url || (!isIframe(currentLesson.url) && !getEmbedUrl(currentLesson.url))"
                                class="w-full h-full flex flex-col items-center justify-center text-zinc-500 bg-zinc-900">
                                <p class="text-sm">Video no disponible o enlace inválido.</p>
                            </div>
                        </div>
                    </template>
                    <template x-if="!currentLesson">
                        <div class="w-full h-full flex items-center justify-center text-zinc-500 bg-zinc-900">
                            <p>Selecciona una lección para comenzar</p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Navigation Buttons Bar -->
            <div class="w-full bg-bgDark border-b border-borderDark/50 py-3">
                <div class="max-w-5xl mx-auto px-4 md:px-0 flex items-center justify-end gap-3">
                    <button @click="prevLesson()" :disabled="!hasPrev"
                        class="px-4 py-2 bg-zinc-800 text-white rounded-lg text-xs font-bold hover:bg-zinc-700 disabled:opacity-30 disabled:cursor-not-allowed transition-colors flex items-center gap-2">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="15 18 9 12 15 6" />
                        </svg>
                        Anterior
                    </button>

                    <button @click="nextLesson()" :disabled="!hasNext"
                        class="px-4 py-2 bg-white text-black rounded-lg text-xs font-bold hover:bg-zinc-200 disabled:opacity-30 disabled:cursor-not-allowed transition-colors flex items-center gap-2">
                        Siguiente
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="9 18 15 12 9 6" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="p-6 max-w-5xl mx-auto w-full">

                <!-- Lesson Navigation & Title -->
                <div
                    class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 border-b border-zinc-800 pb-6">
                    <div>
                        <h2 class="text-2xl lg:text-3xl font-bold text-white mb-2"
                            x-text="currentLesson ? currentLesson.title : 'Bienvenido'"></h2>
                        <p class="text-zinc-400 text-sm font-medium" x-text="currentModuleTitle || 'Módulo'"></p>
                    </div>

                    <div class="flex items-center gap-3 shrink-0">
                        <button @click="markCompleted()" x-show="currentLesson"
                            class="px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider flex items-center gap-2 transition-all border"
                            :class="isCompleted(currentLesson?.id) ? 'bg-green-500/10 text-green-500 border-green-500/50' : 'bg-zinc-800 text-zinc-300 border-zinc-700 hover:bg-zinc-700 hover:text-white'">
                            <svg x-show="isCompleted(currentLesson?.id)" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12" />
                            </svg>
                            <span x-text="isCompleted(currentLesson?.id) ? 'Completado' : 'Marcar visto'"></span>
                        </button>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <div class="flex items-center gap-8 border-b border-zinc-800 mb-6 sticky top-0 bg-bgDark z-10 pt-2">
                    <button @click="activeTab = 'overview'"
                        class="pb-4 text-sm font-semibold border-b-2 transition-colors"
                        :class="activeTab === 'overview' ? 'border-brandPink text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'">
                        Visión General
                    </button>
                    <button @click="activeTab = 'resources'"
                        class="pb-4 text-sm font-semibold border-b-2 transition-colors"
                        :class="activeTab === 'resources' ? 'border-brandPink text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'">
                        Recursos
                    </button>
                    <button @click="activeTab = 'comments'"
                        class="pb-4 text-sm font-semibold border-b-2 transition-colors"
                        :class="activeTab === 'comments' ? 'border-brandPink text-white' : 'border-transparent text-zinc-500 hover:text-zinc-300'">
                        Comentarios <span class="text-xs bg-zinc-800 px-1.5 py-0.5 rounded text-zinc-400 ml-1"
                            x-text="comments.length">0</span>
                    </button>
                </div>

                <!-- Tab Contents -->
                <div class="min-h-[300px]">

                    <!-- Overview Tab -->
                    <div x-show="activeTab === 'overview'" x-transition.opacity>
                        <div class="prose prose-invert max-w-none text-zinc-300 text-sm">
                            <h3 class="text-white text-lg font-bold mb-2">Descripción del Curso</h3>
                            <p
                                x-text="course ? (course.description || course.desc || 'Sin descripción') : 'Sin descripción'">
                            </p>
                            <div class="mt-4 pt-4 border-t border-zinc-800">
                                <h4 class="text-white text-md font-bold mb-1">Duración Aproximada</h4>
                                <p class="text-brandPink font-mono"
                                    x-text="(course ? course.duration : 'N/A') + ' Horas'"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Resources Tab -->
                    <div x-show="activeTab === 'resources'" x-transition.opacity>
                        <div class="grid gap-3">
                            <template
                                x-if="currentLesson && currentLesson.resources && currentLesson.resources.length > 0">
                                <template x-for="res in currentLesson.resources">
                                    <a :href="res.url" target="_blank"
                                        class="flex items-center gap-4 p-4 rounded-xl border border-borderDark bg-cardDark hover:bg-zinc-800 transition-all group">
                                        <div
                                            class="w-10 h-10 bg-zinc-800 rounded-lg flex items-center justify-center text-brandPink group-hover:scale-110 transition-transform">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                                <polyline points="14 2 14 8 20 8" />
                                                <line x1="12" y1="18" x2="12" y2="12" />
                                                <line x1="9" y1="15" x2="15" y2="15" />
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="text-sm font-bold text-white group-hover:text-brandPink transition-colors"
                                                x-text="res.name || 'Recurso descargable'"></div>
                                            <div
                                                class="text-[10px] text-zinc-500 uppercase tracking-wider font-semibold mt-0.5">
                                                Click para descargar</div>
                                        </div>
                                    </a>
                                </template>
                            </template>
                            <div x-show="!currentLesson || !currentLesson.resources || currentLesson.resources.length === 0"
                                class="text-zinc-500 text-center py-10 border border-dashed border-zinc-800 rounded-xl">
                                No hay recursos adjuntos a esta lección.
                            </div>
                        </div>
                    </div>

                    <!-- Comments Tab -->
                    <div x-show="activeTab === 'comments'" x-transition.opacity>
                        <div class="max-w-3xl mx-auto">
                            <!-- Post Input -->
                            <div class="bg-cardDark border border-borderDark rounded-xl p-6 mb-8 shadow-sm">
                                <template x-if="user">
                                    <div class="flex gap-4">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-brandPink to-purple-600 flex items-center justify-center text-white font-bold text-sm shrink-0 shadow-lg"
                                            x-text="user.firstName ? user.firstName.charAt(0) : 'U'"></div>
                                        <div class="flex-1">
                                            <textarea x-model="newComment" rows="2"
                                                class="w-full bg-bgDark border border-borderDark rounded-lg p-3 text-sm text-white focus:outline-none focus:border-brandPink/50 focus:ring-1 focus:ring-brandPink/50 resize-none transition-all placeholder:text-zinc-600"
                                                placeholder="Comparte tus dudas o comentarios..."></textarea>
                                            <div class="flex justify-end mt-3">
                                                <button @click="postComment()"
                                                    class="px-5 py-2 bg-brandPink text-white text-xs font-bold uppercase tracking-wider rounded-lg hover:bg-brandPinkHover transition-all shadow-lg hover:shadow-brandPink/20 disabled:opacity-50 disabled:cursor-not-allowed"
                                                    :disabled="!newComment.trim()">
                                                    Publicar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="!user">
                                    <div class="flex flex-col items-center justify-center py-4 gap-3">
                                        <p class="text-zinc-400 text-sm">Inicia sesión para participar en la comunidad.
                                        </p>
                                        <a href="login.html"
                                            class="px-6 py-2 bg-white text-black text-xs font-bold rounded-full hover:bg-zinc-200 transition-colors">
                                            Iniciar Sesión
                                        </a>
                                    </div>
                                </template>
                            </div>

                            <!-- Comment List -->
                            <div class="space-y-6">
                                <template x-for="comment in comments" :key="comment.id">
                                    <div class="space-y-3">
                                        <!-- Main Comment -->
                                        <div class="flex gap-4 animate-fade-in">
                                            <div class="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center text-zinc-400 font-bold text-sm shrink-0 border border-zinc-700"
                                                x-text="comment.firstName ? comment.firstName.charAt(0) : '?'">
                                            </div>
                                            <div class="flex-1">
                                                <div
                                                    class="bg-cardDark border border-borderDark/50 rounded-r-xl rounded-bl-xl p-4">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <div class="flex items-center gap-2">
                                                            <span class="font-bold text-sm text-white"
                                                                x-text="comment.firstName + ' ' + (comment.lastName || '')"></span>
                                                            <!-- Admin Badge -->
                                                            <span
                                                                x-show="comment.userRole === 'admin' || comment.userRole === 'editor'"
                                                                class="text-[9px] bg-brandPink/20 text-brandPink px-2 py-0.5 rounded-full font-bold uppercase tracking-wider">
                                                                Admin
                                                            </span>
                                                        </div>
                                                        <span class="text-[10px] text-zinc-500 font-medium"
                                                            x-text="formatDate(comment.createdAt)"></span>
                                                    </div>
                                                    <p class="text-zinc-300 text-sm leading-relaxed whitespace-pre-wrap"
                                                        x-text="comment.content"></p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Replies (cascading/nested) -->
                                        <template x-if="comment.replies && comment.replies.length > 0">
                                            <div class="ml-14 space-y-3">
                                                <template x-for="reply in comment.replies" :key="reply.id">
                                                    <div class="flex gap-3 animate-fade-in">
                                                        <div class="w-8 h-8 rounded-full bg-zinc-900 flex items-center justify-center text-zinc-500 font-bold text-xs shrink-0 border border-zinc-800"
                                                            x-text="reply.firstName ? reply.firstName.charAt(0) : '?'">
                                                        </div>
                                                        <div class="flex-1">
                                                            <div
                                                                class="bg-zinc-900 border border-zinc-800 rounded-r-xl rounded-bl-xl p-3">
                                                                <div class="flex items-center justify-between mb-1.5">
                                                                    <div class="flex items-center gap-2">
                                                                        <span class="font-semibold text-xs text-white"
                                                                            x-text="reply.firstName + ' ' + (reply.lastName || '')"></span>
                                                                        <!-- Admin Badge for Replies -->
                                                                        <span
                                                                            x-show="reply.userRole === 'admin' || reply.userRole === 'editor'"
                                                                            class="text-[8px] bg-brandPink/20 text-brandPink px-1.5 py-0.5 rounded-full font-bold uppercase tracking-wider">
                                                                            Admin
                                                                        </span>
                                                                    </div>
                                                                    <span class="text-[9px] text-zinc-600 font-medium"
                                                                        x-text="formatDate(reply.createdAt)"></span>
                                                                </div>
                                                                <p class="text-zinc-400 text-xs leading-relaxed whitespace-pre-wrap"
                                                                    x-text="reply.content"></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                <div x-show="comments.length === 0" class="text-center py-12">
                                    <div
                                        class="w-16 h-16 bg-zinc-900 rounded-full flex items-center justify-center mx-auto mb-4 text-zinc-700">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2">
                                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z">
                                            </path>
                                        </svg>
                                    </div>
                                    <p class="text-zinc-500 text-sm">Aún no hay comentarios.</p>
                                    <p class="text-zinc-600 text-xs mt-1">¡Sé el primero en iniciar la conversación!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Spacing -->
            <div class="h-20"></div>
        </main>

        <!-- Right Column: Sidebar (Desktop) -->
        <aside
            class="hidden lg:flex lg:col-span-3 bg-cardDark border-l border-borderDark flex-col h-full overflow-hidden">
            <div class="p-5 border-b border-borderDark bg-bgDark">
                <h3 class="font-bold text-sm text-white">Contenido del Curso</h3>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <template x-for="(module, mIndex) in (course?.modules || [])" :key="module.id || mIndex">
                    <div>
                        <div class="sticky top-0 z-10 px-5 py-3 bg-zinc-900/95 backdrop-blur border-b border-borderDark/50 text-[10px] font-bold text-zinc-500 uppercase tracking-widest"
                            x-text="module.title"></div>

                        <div class="divide-y divide-borderDark/30">
                            <template x-for="(lesson, lIndex) in (module.lessons || [])" :key="lesson.id || lIndex">
                                <button @click="loadLesson(lesson, module.title)"
                                    class="w-full text-left p-4 hover:bg-white/5 transition-colors group relative flex gap-3"
                                    :class="currentLesson === lesson ? 'bg-white/5 border-l-2 border-brandPink' : 'border-l-2 border-transparent'">

                                    <div class="mt-0.5 shrink-0">
                                        <div class="w-5 h-5 rounded flex items-center justify-center transition-colors"
                                            :class="isCompleted(lesson.id) ? 'bg-green-500 text-black' : 'bg-zinc-800 text-zinc-500 group-hover:bg-zinc-700'">
                                            <svg x-show="isCompleted(lesson.id)" width="12" height="12"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                                <polyline points="20 6 9 17 4 12" />
                                            </svg>
                                            <span x-show="!isCompleted(lesson.id)" class="text-[10px] font-bold"
                                                x-text="lIndex + 1"></span>
                                        </div>
                                    </div>

                                    <div class="min-w-0">
                                        <h4 class="text-xs font-medium text-zinc-300 group-hover:text-white transition-colors truncate leading-snug"
                                            :class="currentLesson === lesson ? 'text-brandPink' : ''"
                                            x-text="lesson.title"></h4>
                                        <div class="flex items-center gap-2 mt-1.5 opacity-60">
                                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none"
                                                class="text-zinc-500" stroke="currentColor" stroke-width="2">
                                                <polygon points="5 3 19 12 5 21 5 3" />
                                            </svg>
                                            <span class="text-[10px] text-zinc-500">Video</span>
                                        </div>
                                    </div>
                                </button>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </aside>

        <!-- Mobile Sidebar (Drawer) -->
        <div x-show="mobileMenuOpen" style="display: none;" class="fixed inset-0 z-50 lg:hidden flex justify-end">

            <div @click="mobileMenuOpen = false"
                class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" x-transition.opacity></div>

            <aside
                class="w-4/5 max-w-sm h-full bg-cardDark border-l border-borderDark flex flex-col relative z-20 shadow-2xl"
                x-transition:enter="transition transform ease-out duration-300"
                x-transition:enter-start="translate-x-full" x-transition:enter-end="translate-x-0"
                x-transition:leave="transition transform ease-in duration-300" x-transition:leave-start="translate-x-0"
                x-transition:leave-end="translate-x-full">

                <div class="p-4 border-b border-borderDark flex items-center justify-between">
                    <h3 class="font-bold text-sm text-white">Contenido del Curso</h3>
                    <button @click="mobileMenuOpen = false"
                        class="p-2 text-zinc-400 hover:text-white rounded-full hover:bg-white/10">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto">
                    <template x-for="(module, mIndex) in (course?.modules || [])" :key="module.id || mIndex">
                        <div>
                            <div class="px-5 py-3 bg-zinc-900/50 text-[10px] font-bold text-zinc-500 uppercase tracking-widest border-b border-borderDark/30"
                                x-text="module.title"></div>
                            <template x-for="(lesson, lIndex) in (module.lessons || [])" :key="lesson.id || lIndex">
                                <button @click="loadLesson(lesson, module.title)"
                                    class="w-full text-left p-4 hover:bg-white/5 border-b border-borderDark/20 flex gap-3"
                                    :class="currentLesson === lesson ? 'bg-white/5' : ''">
                                    <div class="mt-0.5">
                                        <div class="w-5 h-5 rounded flex items-center justify-center"
                                            :class="isCompleted(lesson.id) ? 'bg-green-500 text-black' : 'bg-zinc-800 text-zinc-500'">
                                            <svg x-show="isCompleted(lesson.id)" width="12" height="12"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                                <polyline points="20 6 9 17 4 12" />
                                            </svg>
                                            <span x-show="!isCompleted(lesson.id)" class="text-[10px]"
                                                x-text="lIndex + 1"></span>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-xs font-medium text-zinc-300" x-text="lesson.title"></h4>
                                    </div>
                                </button>
                            </template>
                        </div>
                    </template>
                </div>
            </aside>
        </div>
    </div>

    <script src="./api.js"></script>
    <script>
        function courseViewer() {
            return {
                course: null,
                currentLesson: null,
                currentModuleTitle: '',
                currentModuleIndex: -1,
                currentLessonIndex: -1,
                progress: 0,
                completedModules: [],
                totalLessons: 0,
                comments: [],
                newComment: '',
                mobileMenuOpen: false,
                activeTab: 'overview',
                user: null,

                async init() {
                    // FIX: Ensure session detection is robust (Use correct key 'currentUser')
                    // FIX: Use API to get current user (handles correct storage keys 'storeCurrentUser')
                    try {
                        this.user = await window.API.apiGetProfile();
                        if (this.user) {
                            console.log("Usuario detectado:", this.user.email);
                        } else {
                            console.warn("No se detectó sesión activa.");
                        }
                    } catch (e) {
                        console.error("Error obteniendo perfil:", e);
                    }

                    const params = new URLSearchParams(window.location.search);
                    const courseId = params.get('id');
                    if (!courseId) return window.location.href = 'panel.html';

                    try {
                        let courseFound = null;
                        try {
                            const myCourses = await window.API.apiGetMyPurchasedCourses();
                            const purchased = myCourses.courses.find(c => c.id == courseId);
                            if (purchased) {
                                courseFound = purchased;
                                this.completedModules = purchased.completedLessons || [];
                                this.progress = purchased.progress || 0;

                                if (purchased.status === 'paused') {
                                    alert("Tu acceso a este curso ha sido pausado. Contacta a soporte.");
                                    window.location.href = 'panel.html';
                                    return;
                                }
                            }
                        } catch (ignore) { }

                        if (!courseFound) {
                            const allCourses = await window.API.apiGetProducts();
                            courseFound = allCourses.find(c => c.id == courseId);
                        }

                        this.course = courseFound;

                        if (this.course && this.course.modules) {
                            let count = 0;
                            let first = true;
                            // COllect all valid lesson IDs to sanitize completed list
                            const allLessonIds = [];

                            this.course.modules.forEach((m, mIdx) => {
                                if (m.lessons) {
                                    count += m.lessons.length;
                                    m.lessons.forEach(l => allLessonIds.push(l.id));

                                    if (first && m.lessons.length > 0) {
                                        this.loadLesson(m.lessons[0], m.title, mIdx, 0);
                                        first = false;
                                    }
                                }
                            });
                            this.totalLessons = count;

                            // Recalculate progress based on current actual lessons
                            // Only count completed lessons that actually exist in the course now
                            if (this.completedModules && this.completedModules.length > 0) {
                                this.completedModules = this.completedModules.filter(id => allLessonIds.includes(id));
                                this.calculateProgress();
                            } else {
                                this.progress = 0;
                            }
                        }

                    } catch (e) {
                        console.error("Error loading course", e);
                    }
                },

                loadLesson(lesson, modTitle, mIdx = -1, lIdx = -1) {
                    this.currentLesson = lesson;
                    this.currentModuleTitle = modTitle;

                    if (mIdx === -1 && this.course) {
                        this.course.modules.forEach((m, i) => {
                            const foundWrapped = m.lessons.findIndex(l => l.id === lesson.id);
                            if (foundWrapped !== -1) { mIdx = i; lIdx = foundWrapped; }
                        });
                    }
                    this.currentModuleIndex = mIdx;
                    this.currentLessonIndex = lIdx;
                    this.mobileMenuOpen = false;

                    // Reset tab to overview on new lesson? Optional. Let's keep current tab.
                    this.fetchComments();
                },

                formatDate(dateStr) {
                    if (!dateStr) return '';
                    return new Date(dateStr).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
                },

                prevLesson() {
                    if (!this.course || this.currentModuleIndex === -1) return;
                    let m = this.currentModuleIndex, l = this.currentLessonIndex - 1;

                    if (l < 0) {
                        m--;
                        if (m < 0) return;
                        l = this.course.modules[m].lessons.length - 1;
                    }
                    this.loadLesson(this.course.modules[m].lessons[l], this.course.modules[m].title, m, l);
                },

                nextLesson() {
                    if (!this.course || this.currentModuleIndex === -1) return;
                    let m = this.currentModuleIndex, l = this.currentLessonIndex + 1;

                    if (l >= this.course.modules[m].lessons.length) {
                        m++;
                        if (m >= this.course.modules.length) return;
                        l = 0;
                    }
                    this.loadLesson(this.course.modules[m].lessons[l], this.course.modules[m].title, m, l);
                },

                get hasPrev() {
                    if (this.currentModuleIndex === 0 && this.currentLessonIndex === 0) return false;
                    return true;
                },

                get hasNext() {
                    if (!this.course) return false;
                    const lastModIdx = this.course.modules.length - 1;
                    const lastMod = this.course.modules[lastModIdx];
                    if (!lastMod.lessons.length) return false;
                    if (this.currentModuleIndex === lastModIdx && this.currentLessonIndex === lastMod.lessons.length - 1) return false;
                    return true;
                },

                isCompleted(lessonId) {
                    return this.completedModules.includes(lessonId);
                },

                async markCompleted() {
                    if (!this.currentLesson) return;
                    if (!this.completedModules.includes(this.currentLesson.id)) {
                        this.completedModules.push(this.currentLesson.id);
                        this.calculateProgress();
                        try {
                            await window.API.apiUpdateProgress(this.course.id, this.progress, 0.5, this.completedModules);
                        } catch (e) { console.error(e); }
                    }
                },

                calculateProgress() {
                    if (this.totalLessons === 0) return;
                    // Ensure we don't go over 100 due to any sync issues
                    const p = Math.round((this.completedModules.length / this.totalLessons) * 100);
                    this.progress = p > 100 ? 100 : p;
                },

                async fetchComments() {
                    if (!this.currentLesson || !this.course) return;
                    this.comments = [];
                    try {
                        const res = await fetch(`/api/comments?courseId=${this.course.id}&lessonId=${this.currentLesson.id}`);
                        if (res.ok) this.comments = await res.json();
                    } catch (e) { console.error(e); }
                },

                async postComment() {
                    if (!this.newComment.trim() || !this.user) return;
                    try {
                        const res = await fetch('/api/comments', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: this.user.id,
                                courseId: this.course.id,
                                lessonId: this.currentLesson.id,
                                content: this.newComment
                            })
                        });
                        if (res.ok) {
                            this.newComment = '';
                            this.fetchComments();
                        } else {
                            try {
                                const errData = await res.json();
                                alert(errData.error || 'Error al publicar comentario');
                                if (res.status === 404 && errData.error && errData.error.includes('Usuario')) {
                                    alert('Tu sesión no es válida en este servidor. Por favor inicia sesión nuevamente.');
                                    window.API.apiLogout();
                                }
                            } catch (e) {
                                alert('Error al publicar comentario (Status ' + res.status + ')');
                            }
                        }
                    } catch (e) { console.error(e); }
                },

                isIframe(url) { return url && url.trim().startsWith('<iframe'); },

                getEmbedUrl(url) {
                    if (!url || this.isIframe(url)) return '';
                    let videoId = null;
                    try {
                        const safeUrl = url.startsWith('http') ? url : `https://${url}`;
                        const u = new URL(safeUrl);
                        if (u.hostname.includes('youtube.com')) {
                            if (u.searchParams.has('v')) videoId = u.searchParams.get('v');
                            else if (u.pathname.split('/')[2]) videoId = u.pathname.split('/')[2];
                        } else if (u.hostname.includes('youtu.be')) videoId = u.pathname.slice(1);
                    } catch (e) { }

                    if (!videoId) {
                        const match = url.match(/[?&]v=([^&]+)/);
                        if (match) videoId = match[1];
                        else {
                            const sm = url.match(/youtu\.be\/([^?&]+)/);
                            if (sm) videoId = sm[1];
                        }
                    }

                    if (videoId && videoId.length === 11) {
                        return `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&playsinline=1&iv_load_policy=3`;
                    }
                    if (url.includes('vimeo.com')) {
                        const vm = url.match(/vimeo\.com\/(\d+)/);
                        if (vm) return `https://player.vimeo.com/video/${vm[1]}`;
                    }
                    return '';
                }
            }
        }
    </script>
</body>

</html>